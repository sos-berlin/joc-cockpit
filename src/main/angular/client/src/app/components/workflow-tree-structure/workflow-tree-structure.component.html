<ng-template #itemTemplate let-order>
  <ng-template #contentTemplate>
    <div class="p-l-sm">
      <span translate> order.label.state </span>:
      <span class="_600"> {{order.state._text | translate}}</span>
    </div>
    @if (order.state._reason) {
      <div class="p-l-sm">
        <span translate> common.label.comment </span>:
        <span class="_600"> {{order.state._reason}}</span>
      </div>
    }
    @if (order.question) {
      <div class="p-l-sm">
        <span translate> workflow.label.prompt </span>:
        <span class="_600"> {{order.question}}</span>
      </div>
    }
    @if (order.lastOutcome) {
      <div class="p-l-sm">
        <span translate> order.label.lastOutcome </span>:
        <span class="_600">{{order.lastOutcome.TYPE}}</span>
      </div>
    }
    @if (!order.cyclicOrder) {
      <div class="p-l-sm">
        <span translate> order.label.scheduledFor </span>:
        @if (!order.scheduledNever) {
          <span class="_600">{{order.scheduledFor | stringToDate}}</span>
        }
        @if (order.scheduledNever) {
          <span class="_600 text-l-c" translate>common.label.never</span>
        }
      </div>
    }
    @if (order.cyclicOrder) {
      <div class="m-a-sm m-t-0">
        <div class="_600 m-b-xs" translate>dailyPlan.label.cyclicOrder</div>
        <span class="_600 p-l-sm" translate>dailyPlan.label.begin</span>:
        {{order.cyclicOrder.firstStart | stringToDate}}
        <br>
        <span class="_600 p-l-sm" translate>dailyPlan.label.end</span>:
        {{order.cyclicOrder.lastStart | stringToDate}}
        <br>
        <span class="_600 p-l-sm" translate>order.label.orders</span>:
        {{order.cyclicOrder.count}}
      </div>
    }
    @if (order.cycleState) {
      <div class="m-a-sm m-t-0">
        <div class="_600 m-b-xs" translate>order.cycleState.label.cycleState</div>
        @if (order.cycleState.since) {
          <span>
            <span class="_600 p-l-sm" translate>order.cycleState.label.since</span>:
            {{order.cycleState.since | stringToDate}}
          </span>
        }
        @if (order.cycleState.next) {
          <span>
            <span class="_600 p-l-sm" translate>order.cycleState.label.next</span>:
            {{order.cycleState.next | stringToDate}}
          </span>
        }
        <br>
        <span class="_600 p-l-sm" translate>order.cycleState.label.index</span>:
        {{order.cycleState.index}}
      </div>
    }
    @if (order.retryState) {
      <div class="m-a-sm m-t-0">
        <div class="_600 m-b-xs" translate>order.retryState.label.retryState</div>
        @if (order.retryState.next) {
          <span>
            <span class="_600 p-l-sm" translate>order.retryState.label.next</span>:
            {{ order.retryState.next | stringToDate }}
          </span>
        }
        <br>
        <span class="_600 p-l-sm" translate>order.retryState.label.attempt</span>:
        {{ order.retryState.attempt }}
      </div>
    }
    @if (order.sleepState) {
      <div class="m-a-sm m-t-0">
        <div class="_600 m-b-xs" translate>order.sleepState.label.sleepState</div>
        @if (order.sleepState.until) {
          <span>
            <span class="_600 p-l-sm" translate>order.sleepState.label.until</span>:
            {{ order.sleepState.until | stringToDate }}
          </span>
        }
      </div>
    }
    @if (order.priority) {
      <div class="p-l-sm">
        <span translate> order.label.priority </span>:
        <span class="_600">{{order.priority}}</span>
      </div>
    }
  </ng-template>
  <span [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="contentTemplate" nzTooltipPlacement="right">
    <i [ngClass]="coreService.getColor(order.state.severity, 'text')" class="fa fa-circle p-r-s"></i>
    {{order.orderId}} @if (order.cyclicOrder) {<i aria-hidden="true" class="fa fa-repeat p-l-xs p-r-xs"></i>}
    @if (order.scheduledFor && !order.scheduledNever) {
      <i class="text-sm text-muted">{{order.scheduledFor | stringToDate}}</i>
    }
    @if (order.scheduledNever) {
      <i class="text-sm text-muted" translate>common.label.never</i>
    }
  </span>
</ng-template>

<ng-template #itemTemplate2 let-currentOrder="currentOrder" let-orders>
  <ng-template #contentTemplate2>
    @for (order of orders | keyvalue; track trackByOrderKey($index, order)) {
      <div class="p-l-sm">
        @if (order.value['orderId'] !== currentOrder.orderId) {
          <ng-container>
            <i [ngClass]="coreService.getColor(order.value['state'].severity, 'text')" class="fa fa-circle p-r-s"></i>
            {{order.value['orderId']}} @if (order.value['cyclicOrder']) {<i aria-hidden="true" class="fa fa-repeat p-l-xs p-r-xs"></i>}
            @if (order.value['scheduledFor'] && !order.value['scheduledNever']) {
              <i class="text-sm text-muted">{{order.value['scheduledFor'] | stringToDate}}</i>
            }
            @if (order.value['scheduledNever']) {
              <i class="text-sm text-muted" translate>common.label.never</i>
            }
          </ng-container>
        }
      </div>
    }
  </ng-template>
  <span [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="contentTemplate2" class="_600"> {{orders.size - 1}} others</span>
</ng-template>

@for (instruction of configuration.instructions; track trackByInstruction($index, instruction); let i = $index) {
  <div>
    <ul class="m-b-0">
      <li (dragend)="dragend($event)" (dragenter)="drag($event);">
        @if (instruction.TYPE === 'Fork' || instruction.TYPE === 'ForkList' || instruction.TYPE === 'ConsumeNotices' || instruction.TYPE === 'If' || instruction.TYPE === 'Try' || instruction.TYPE === 'CaseWhen' || instruction.TYPE === 'When' || instruction.TYPE === 'ElseWhen' || instruction.TYPE === 'Retry' || instruction.TYPE === 'Cycle' || instruction.TYPE === 'Lock' || instruction.TYPE === 'Options' || instruction.TYPE === 'StickySubagent') {
          <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
               class="hover"
               id="{{instruction.positionString}}">
            @if (instruction.TYPE === 'If' || instruction.TYPE === 'Cycle') {
              <div class="btn-group dropdown m-l-n-10">
                <button [nzDropdownMenu]="menu" class="btn-drop more-option-h" nz-dropdown nzTrigger="click" type="button">
                  <i class="fa fa-ellipsis-h"></i>
                </button>
                <nz-dropdown-menu #menu="nzDropdownMenu" role="menu">
                  <ul nz-menu>
                    <li (click)="showConfiguration(instruction);" nz-menu-item>
                      <a translate>common.button.showConfiguration</a>
                    </li>
                  </ul>
                </nz-dropdown-menu>
              </div>
            }
            <i (click)="collapse(instruction)" [ngClass]="{'fa-minus' : (instruction.show)}" class="fa fa-plus pr-2"></i>
            <span class="_600">
              {{instruction.TYPE === 'ElseWhen' ? 'Else' : instruction.TYPE}}
              @if (instruction.label) {
                <i class="p-l-xs p-r-xs text-muted _400">({{instruction.label}})</i>
              }
              @if (instruction.TYPE === 'Lock') {
                <span>: </span>
              }
              @if ((instruction.TYPE === 'Lock')) {
                <span>
                  @for (item of instruction.demands; track trackByDemand($index, item)) {
                    <span class="text-muted">
                      <span [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="lockItemTemplate" class="text-muted">
                        {{item.lockName}}
                      </span>
                      <ng-template #lockItemTemplate>
                        <div>
                          <div class="p-l-sm">
                            <span translate> workflow.label.count </span>:
                            <span class="_600">{{item.count}}</span>
                          </div>
                        </div>
                      </ng-template>
                    </span>
                  }
                </span>
              }
              @if ((instruction.TYPE === 'ConsumeNotices') && instruction.noticeBoardNames) {
                <span [innerHTML]="coreService.getHtml(instruction.noticeBoardNames, permission, configuration.path) | safeHtml"
                      class="text-muted"></span>
              }
            </span>

            <span class="expand-collapse-btn">
              <i (click)="expandNode(instruction)" class="fa fa-lg fa-angle-double-down"></i>
              <i (click)="collapseNode(instruction)" class="fa fa-lg fa-angle-double-up p-l-xs"></i>
            </span>
            @if (instruction.order) {
              <span class="m-l">
                <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                  @if (instruction.order) {
                    <span>
                      <ng-container [ngTemplateOutletContext]="{ $implicit: instruction.order}"
                                    [ngTemplateOutlet]="itemTemplate"></ng-container>
                      @if (orders && orders.size - 1 > 0) {
                        <span class="order-count">
                          <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.order}"
                                        [ngTemplateOutlet]="itemTemplate2"></ng-container>
                        </span>
                      }
                    </span>
                  }
                </div>
              </span>
            }
          </div>
        }
        @if (instruction.TYPE === 'Job' || instruction.TYPE === 'AddOrder' || instruction.TYPE === 'Fail' || instruction.TYPE === 'Sleep' || instruction.TYPE === 'Finish' || instruction.TYPE === 'ImplicitEnd' || instruction.TYPE === 'PostNotices' || instruction.TYPE === 'Prompt' || instruction.TYPE === 'Break' || instruction.TYPE === 'ExpectNotices') {
          <div [ngClass]="{'m-t-xs m-l-n-40 text-primary': instruction.TYPE === 'ImplicitEnd', 'drop-area': instruction.enabled}"
               id="{{instruction.positionString}}">
            @if (instruction.TYPE === 'Job') {
              <div class="btn-group dropdown m-l-n-10">
                <button [nzDropdownMenu]="menu" class="btn-drop more-option-h" nz-dropdown nzTrigger="click" type="button">
                  <i class="fa fa-ellipsis-h"></i>
                </button>
                <nz-dropdown-menu #menu="nzDropdownMenu" role="menu">
                  <ul nz-menu>
                    <li (click)="showConfiguration(instruction);" nz-menu-item>
                      <a translate>common.button.showConfiguration</a>
                    </li>
                  </ul>
                </nz-dropdown-menu>
              </div>
            }
            @if (instruction.TYPE === 'Job') {
              <span (click)="showConfiguration(instruction)"
                    [ngClass]="{'drop-area-text' : instruction.enabled}" class="cursor inst-text"
                    id="{{instruction.positionString}}$">{{instruction.jobName}}</span>
            }
            @if (instruction.TYPE === 'Job' && instruction.label) {
              <i class="p-l-xs p-r-xs text-muted _400">({{instruction.label}})</i>
            }
            @if (instruction.TYPE !== 'Job') {
              <span [ngClass]="{'drop-area-text' : instruction.enabled}"
                    [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="(instruction.question || instruction.message)" class="inst-text"
                    id="{{instruction.positionString}}$">
                {{instruction.TYPE | translate}}
                @if (instruction.label) {
                  <i class="p-l-xs p-r-xs text-muted _400">({{instruction.label}})</i>
                }
                @if ((instruction.TYPE === 'PostNotices' || instruction.TYPE === 'ExpectNotices')) {
                  <span>: </span>
                }
                @if ((instruction.TYPE === 'PostNotices' || instruction.TYPE === 'ExpectNotices') && instruction.noticeBoardNames) {
                  <span [ngClass]="{'drop-area-text' : instruction.enabled}"
                        class="text-muted"
                        id="{{instruction.positionString}}$">
                    {{instruction.noticeBoardNames}}
                  </span>
                }
              </span>
            }

            @if (instruction.order) {
              <span class="m-l-md">
                <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                  @if (instruction.order) {
                    <span>
                      <ng-container [ngTemplateOutletContext]="{ $implicit: instruction.order}"
                                    [ngTemplateOutlet]="itemTemplate"></ng-container>
                      @if (orders && orders.size - 1 > 0) {
                        <span class="order-count">
                          <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.order}"
                                        [ngTemplateOutlet]="itemTemplate2"></ng-container>
                        </span>
                      }
                    </span>
                  }
                </div>
              </span>
            }
          </div>
        }
        @if (instruction.TYPE === 'ForkListEnd' || instruction.TYPE === 'CycleEnd') {
          <div [ngClass]="{'drop-area': instruction.enabled}" class="m-l-n-40"
               id="{{instruction.positionString}}">
            @if (instruction.TYPE === 'ForkListEnd') {
              <span [ngClass]="{'drop-area-text' : instruction.enabled}"
                    class="inst-text _600"
                    id="{{instruction.positionString}}$">{{'workflow.label.forkListEnd' | translate}}
              </span>
            }
            @if (instruction.TYPE === 'CycleEnd') {
              <span [ngClass]="{'drop-area-text' : instruction.enabled}"
                    class="inst-text _600"
                    id="{{instruction.positionString}}$">{{'workflow.label.cycleEnd' | translate}}
              </span>
            }
            @if (instruction.order) {
              <span class="m-l-md">
                <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                  @if (instruction.order) {
                    <span>
                      <ng-container [ngTemplateOutletContext]="{ $implicit: instruction.order}"
                                    [ngTemplateOutlet]="itemTemplate"></ng-container>
                      @if (orders && orders.size - 1 > 0) {
                        <span class="order-count">
                          <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.order}"
                                        [ngTemplateOutlet]="itemTemplate2"></ng-container>
                        </span>
                      }
                    </span>
                  }
                </div>
              </span>
            }
          </div>
        }
        @if (instruction.TYPE === 'Fork' && (instruction.show)) {
          <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}" id="{{instruction.positionString}}">
            @for (branch of instruction.branches; track trackByBranch($index, branch)) {
              <div>
                <div class="p-l-md">
                  <a (click)="collapse(branch)" class="m-l">
                    <i [ngClass]="{'fa-minus' : (branch.show)}" class="fa fa-plus pr-2"></i>
                    <i [ngClass]="{'drop-area-text' : instruction.enabled}" class="_600 inst-text"
                       id="{{instruction.positionString}}$">{{branch.id}}</i>
                  </a>
                  @if (branch.order) {
                    <span class="m-l-md">
                      <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                        @if (branch.order) {
                          <span>
                            <ng-container [ngTemplateOutletContext]="{ $implicit: branch.order}"
                                          [ngTemplateOutlet]="itemTemplate"></ng-container>
                            @if (orders && orders.size - 1 > 0) {
                              <span class="order-count">
                                <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: branch.order}"
                                              [ngTemplateOutlet]="itemTemplate2"></ng-container>
                              </span>
                            }
                          </span>
                        }
                      </div>
                    </span>
                  }
                  @if (branch.instructions && (branch.show)) {
                    <div class="p-l">
                      <app-workflow-tree-structure [configuration]="branch" [disabledDrag]="disabledDrag" [expandAll]="expandAll"
                                                   [jobs]="jobs" [orders]="orders"
                                                   [timezone]="timezone"></app-workflow-tree-structure>
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
        @if (instruction.TYPE === 'If' && (instruction.show)) {
          <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}" id="{{instruction.positionString}}">
            @if (instruction.then && instruction.then.instructions) {
              <div>
                <app-workflow-tree-structure [configuration]="instruction.then" [disabledDrag]="disabledDrag"
                                             [expandAll]="expandAll" [jobs]="jobs" [orders]="orders"
                                             [timezone]="timezone">
                </app-workflow-tree-structure>
                <div class="p-l-md">
                  @if (instruction.else) {
                    <a (click)="collapse(instruction.else)" class="m-l">
                      <i [ngClass]="{'fa-minus' : (instruction.else.show)}" class="fa fa-plus pr-2"></i>
                      <span [ngClass]="{'drop-area-text' : instruction.enabled}" class="_600 inst-text"
                            id="{{instruction.positionString}}$">Else</span>
                    </a>
                  }
                  @if (instruction.else && (instruction.else.order)) {
                    <span class="m-l-md">
                      <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                        @if (instruction.else.order) {
                          <span>
                            <ng-container [ngTemplateOutletContext]="{ $implicit: instruction.else.order }"
                                          [ngTemplateOutlet]="itemTemplate"></ng-container>
                            @if (orders && orders.size - 1 > 0) {
                              <span class="order-count">
                                <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.else.order}"
                                              [ngTemplateOutlet]="itemTemplate2">
                                </ng-container>
                              </span>
                            }
                          </span>
                        }
                      </div>
                    </span>
                  }
                  @if (instruction.else && (instruction.else.show)) {
                    <div class="p-l">
                      @if (instruction.else.instructions) {
                        <app-workflow-tree-structure [configuration]="instruction.else"
                                                     [disabledDrag]="disabledDrag" [expandAll]="expandAll" [jobs]="jobs"
                                                     [orders]="orders"
                                                     [timezone]="timezone"></app-workflow-tree-structure>
                      }
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }
        @if (instruction.TYPE === 'Try' && (instruction.show)) {
          <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}" id="{{instruction.positionString}}">
            @if (instruction.instructions) {
              <app-workflow-tree-structure [configuration]="instruction" [disabledDrag]="disabledDrag"
                                           [expandAll]="expandAll" [jobs]="jobs" [orders]="orders"
                                           [timezone]="timezone">
              </app-workflow-tree-structure>
            }
            @if (instruction.catch && instruction.catch.instructions) {
              <div class="p-l-md">
                <a (click)="collapse(instruction.catch)" class="m-l">
                  <i [ngClass]="{'fa-minus' : (instruction.catch.show)}" class="fa fa-plus pr-2"></i>
                  <span [ngClass]="{'drop-area-text' : instruction.enabled}" class="_600 inst-text"
                        id="{{instruction.positionString}}$" translate>workflow.label.catch</span>
                </a>
                @if ((instruction.catch.order)) {
                  <span class="m-l-md">
                    <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                      @if (instruction.catch.order) {
                        <span>
                          <ng-container [ngTemplateOutletContext]="{ $implicit: instruction.catch.order}"
                                        [ngTemplateOutlet]="itemTemplate"></ng-container>
                          @if (orders && orders.size - 1 > 0) {
                            <span class="order-count">
                              <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.catch.order}"
                                            [ngTemplateOutlet]="itemTemplate2">
                              </ng-container>
                            </span>
                          }
                        </span>
                      }
                    </div>
                  </span>
                }
                @if ((instruction.catch.show)) {
                  <div class="m-l">
                    @if (instruction.catch.instructions) {
                      <app-workflow-tree-structure [configuration]="instruction.catch"
                                                   [disabledDrag]="disabledDrag" [expandAll]="expandAll" [jobs]="jobs"
                                                   [orders]="orders"
                                                   [timezone]="timezone"></app-workflow-tree-structure>
                    }
                  </div>
                }
              </div>
            }
          </div>
        }
        @if ((instruction.TYPE === 'Retry' || instruction.TYPE === 'Cycle' || instruction.TYPE === 'CaseWhen' || instruction.TYPE === 'When' || instruction.TYPE === 'ElseWhen' || instruction.TYPE === 'Lock' || instruction.TYPE === 'Options' || instruction.TYPE === 'StickySubagent' || instruction.TYPE === 'ForkList' ||  instruction.TYPE === 'ConsumeNotices') && (instruction.show)) {
          <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
               id="{{instruction.positionString}}">
            <div>
              @if (instruction.instructions) {
                <app-workflow-tree-structure [configuration]="instruction" [disabledDrag]="disabledDrag"
                                             [expandAll]="expandAll" [jobs]="jobs" [orders]="orders"
                                             [timezone]="timezone">
                </app-workflow-tree-structure>
              }
            </div>
          </div>
        }
        @if (instruction.join) {
          <div [ngClass]="{'drop-area': instruction.join.enabled}"
               id="{{instruction.join.unique}}">
            <span [ngClass]="{'drop-area-text' : instruction.enabled}" class="_600 inst-text"
                  id="{{instruction.join.unique}}$">
              {{'workflow.label.join' | translate}}
            </span>
            @if (instruction.join.order) {
              <span class="m-l-md">
                <div [draggable]="!disabledDrag" [ngClass]="disabledDrag ? 'inline' : 'draggable'">
                  @if (instruction.join.order) {
                    <span>
                      <ng-container [ngTemplateOutletContext]="{ $implicit: instruction.join.order}"
                                    [ngTemplateOutlet]="itemTemplate"></ng-container>
                      @if (orders && orders.size - 1 > 0) {
                        <span class="order-count">
                          <ng-container [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.join.order}"
                                        [ngTemplateOutlet]="itemTemplate2"></ng-container>
                        </span>
                      }
                    </span>
                  }
                </div>
              </span>
            }
          </div>
        }
      </li>
    </ul>
  </div>
}
