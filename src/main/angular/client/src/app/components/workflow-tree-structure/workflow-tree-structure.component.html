<ng-template #itemTemplate let-order>
  <ng-template #contentTemplate>
    <div class="p-l-sm">
      <span translate> order.label.state </span>:
      <span class="_600"> {{order.state._text | translate}}</span>
    </div>
    <div class="p-l-sm" *ngIf="order.state._reason">
      <span translate> common.label.comment </span>:
      <span class="_600"> {{order.state._reason}}</span>
    </div>
    <div class="p-l-sm" *ngIf="order.question">
      <span translate> workflow.label.prompt </span>:
      <span class="_600"> {{order.question}}</span>
    </div>
    <div class="p-l-sm" *ngIf="order.lastOutcome">
      <span translate> order.label.lastOutcome </span>:
      <span class="_600">{{order.lastOutcome.TYPE}}</span>
    </div>
    <div class="p-l-sm" *ngIf="!order.cyclicOrder">
      <span translate> order.label.scheduledFor </span>:
      <span class="_600" *ngIf="!order.scheduledNever">{{order.scheduledFor | stringToDate}}</span>
      <span class="_600 text-l-c" *ngIf="order.scheduledNever" translate>common.label.never</span>
    </div>
    <div class="m-a-sm m-t-0" *ngIf="order.cyclicOrder">
      <div class="_600 m-b-xs" translate>dailyPlan.label.cyclicOrder</div>
      <span class="_600 p-l-sm" translate>dailyPlan.label.begin</span>:
      {{order.cyclicOrder.firstStart | stringToDate}}
      <br>
      <span class="_600 p-l-sm" translate>dailyPlan.label.end</span>:
      {{order.cyclicOrder.lastStart | stringToDate}}
      <br>
      <span class="_600 p-l-sm" translate>order.label.orders</span>:
      {{order.cyclicOrder.count}}
    </div>
    <div class="m-a-sm m-t-0" *ngIf="order.cycleState">
      <div class="_600 m-b-xs" translate>order.cycleState.label.cycleState</div>
      <span *ngIf="order.cycleState.since">
        <span class="_600 p-l-sm" translate>order.cycleState.label.since</span>:
        {{order.cycleState.since | stringToDate}}
      </span>
      <span *ngIf="order.cycleState.next">
        <span class="_600 p-l-sm" translate>order.cycleState.label.next</span>:
        {{order.cycleState.next | stringToDate}}
      </span>
      <br>
      <span class="_600 p-l-sm" translate>order.cycleState.label.index</span>:
      {{order.cycleState.index}}
    </div>
  </ng-template>
  <span [nz-tooltip]="contentTemplate" nzTooltipPlacement="right">
    <i class="fa fa-circle p-r-s" [ngClass]="coreService.getColor(order.state.severity, 'text')"></i>
    {{order.orderId}} <i *ngIf="order.cyclicOrder" class="fa fa-repeat p-l-xs p-r-xs" aria-hidden="true"></i>
    <i class="text-sm text-muted" *ngIf="order.scheduledFor && !order.scheduledNever">{{order.scheduledFor |
      stringToDate}}</i>
    <i class="text-sm text-muted" *ngIf="order.scheduledNever" translate>common.label.never</i>
  </span>
</ng-template>
<ng-template #itemTemplate2 let-orders let-currentOrder="currentOrder">
  <ng-template #contentTemplate2>
    <div class="p-l-sm" *ngFor="let order of orders | keyvalue;">
      <ng-container *ngIf="order.value.orderId !== currentOrder.orderId">
        <i class="fa fa-circle p-r-s" [ngClass]="coreService.getColor(order.value.state.severity, 'text')"></i>
        {{order.value.orderId}} <i *ngIf="order.value.cyclicOrder" class="fa fa-repeat p-l-xs p-r-xs"
          aria-hidden="true"></i>
        <i class="text-sm text-muted"
          *ngIf="order.value.scheduledFor && !order.value.scheduledNever">{{order.value.scheduledFor |
          stringToDate}}</i>
        <i class="text-sm text-muted" *ngIf="order.value.scheduledNever" translate>common.label.never</i>
      </ng-container>
    </div>
  </ng-template>
  <span class="_600" [nz-tooltip]="contentTemplate2"> {{orders.size - 1}} others</span>
</ng-template>
<div *ngFor="let instruction of configuration.instructions; let i = index">
  <ul class="m-b-0">
    <li (dragover)="drag($event);" (dragend)="dragend($event)">
      <div class="hover"
        [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
        id="{{instruction.positionString}}"
        *ngIf="instruction.TYPE === 'Fork' || instruction.TYPE === 'ForkList' || instruction.TYPE === 'ConsumeNotices' || instruction.TYPE === 'If' || instruction.TYPE === 'Try' || instruction.TYPE === 'Retry' || instruction.TYPE === 'Cycle'
         || instruction.TYPE === 'Lock' || instruction.TYPE === 'StickySubagent'">
        <div class="btn-group dropdown m-l-n-10" *ngIf="instruction.TYPE === 'If' || instruction.TYPE === 'Cycle'">
          <button class="btn-drop more-option-h" nz-dropdown nzTrigger="click" [nzDropdownMenu]="menu" type="button">
            <i class="fa fa-ellipsis-h"></i>
          </button>
          <nz-dropdown-menu #menu="nzDropdownMenu" role="menu">
            <ul nz-menu>
              <li nz-menu-item (click)="showConfiguration(instruction);">
                <a translate>common.button.showConfiguration</a>
              </li>
            </ul>
          </nz-dropdown-menu>
        </div>
        <i (click)="collapse(instruction)" class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (instruction.show)}"></i>
        <span class="_600">
          {{instruction.TYPE}}
          <span *ngIf="instruction.TYPE === 'Lock'">: </span>
          <span *ngIf="(instruction.TYPE === 'Lock')">
            <span class="text-muted" *ngFor="let item of instruction.demands">
              <span [nz-tooltip]="lockItemTemplate" class="text-muted">
                {{item.lockName}}
              </span>
              <ng-template #lockItemTemplate>
                <div>
                  <div class="p-l-sm">
                    <span translate> workflow.label.count </span>:
                    <span class="_600">{{item.count}}</span>
                  </div>
                </div>
              </ng-template>
            </span>
          </span>
          <span class="text-muted" *ngIf="(instruction.TYPE === 'ConsumeNotices') && instruction.noticeBoardNames"
          [innerHTML]="coreService.getHtml(instruction.noticeBoardNames, permission) | safeHtml"></span>
        </span>

        <span class="expand-collapse-btn">
          <i class="fa fa-lg fa-angle-double-down" (click)="expandNode(instruction)"></i>
          <i class="fa fa-lg fa-angle-double-up p-l-xs" (click)="collapseNode(instruction)"></i>
        </span>
        <span class="m-l" *ngIf="instruction.order">
          <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
            <span *ngIf="instruction.order">
              <ng-container [ngTemplateOutlet]="itemTemplate"
                [ngTemplateOutletContext]="{ $implicit: instruction.order}"></ng-container>
              <span class="order-count" *ngIf="orders && orders.size - 1 > 0">
                <ng-container [ngTemplateOutlet]="itemTemplate2"
                  [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.order}"></ng-container>
              </span>
            </span>
          </div>
        </span>
      </div>
      <div id="{{instruction.positionString}}" *ngIf="instruction.TYPE === 'Job' || instruction.TYPE === 'AddOrder' || instruction.TYPE === 'Fail' || instruction.TYPE === 'Finish' || instruction.TYPE === 'ImplicitEnd'
       || instruction.TYPE === 'PostNotices' || instruction.TYPE === 'Prompt' || instruction.TYPE === 'ExpectNotices'"
        [ngClass]="{'m-t-xs m-l-n-40 text-primary': instruction.TYPE === 'ImplicitEnd', 'drop-area': instruction.enabled}">
        <div class="btn-group dropdown m-l-n-10" *ngIf="instruction.TYPE === 'Job'">
          <button class="btn-drop more-option-h" nz-dropdown nzTrigger="click" [nzDropdownMenu]="menu" type="button">
            <i class="fa fa-ellipsis-h"></i>
          </button>
          <nz-dropdown-menu #menu="nzDropdownMenu" role="menu">
            <ul nz-menu>
              <li nz-menu-item (click)="showConfiguration(instruction);">
                <a translate>common.button.showConfiguration</a>
              </li>
            </ul>
          </nz-dropdown-menu>
        </div>
        <span class="cursor inst-text" *ngIf="instruction.TYPE === 'Job'"
          (click)="showConfiguration(instruction)">{{instruction.jobName}}</span>
        <span class="inst-text" *ngIf="instruction.TYPE !== 'Job'"
          [nz-tooltip]="instruction.question || instruction.message">
          {{instruction.TYPE | translate}}
          <span *ngIf="(instruction.TYPE === 'PostNotices' || instruction.TYPE === 'ExpectNotices')">: </span>
          <span class="text-muted"
            *ngIf="(instruction.TYPE === 'PostNotices' || instruction.TYPE === 'ExpectNotices') && instruction.noticeBoardNames">
            {{instruction.noticeBoardNames}}
          </span>
        </span>
        <span class="m-l-md" *ngIf="instruction.order">
          <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
            <span *ngIf="instruction.order">
              <ng-container [ngTemplateOutlet]="itemTemplate"
                [ngTemplateOutletContext]="{ $implicit: instruction.order}"></ng-container>
              <span class="order-count" *ngIf="orders && orders.size - 1 > 0">
                <ng-container [ngTemplateOutlet]="itemTemplate2"
                  [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.order}"></ng-container>
              </span>
            </span>
          </div>
        </span>
      </div>
      <div id="{{instruction.positionString}}" *ngIf="instruction.TYPE === 'ForkListEnd'" class="m-l-n-40"
        [ngClass]="{'drop-area': instruction.enabled}">
        <span class="inst-text">
          <span class="_600" *ngIf="instruction.TYPE === 'ForkListEnd'">{{'workflow.label.forkListEnd' |
            translate}}</span>
        </span>
        <span class="m-l-md" *ngIf="instruction.order">
          <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
            <span *ngIf="instruction.order">
              <ng-container [ngTemplateOutlet]="itemTemplate"
                [ngTemplateOutletContext]="{ $implicit: instruction.order}"></ng-container>
              <span class="order-count" *ngIf="orders && orders.size - 1 > 0">
                <ng-container [ngTemplateOutlet]="itemTemplate2"
                  [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.order}"></ng-container>
              </span>
            </span>
          </div>
        </span>
      </div>
      <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
        id="{{instruction.positionString}}" *ngIf="instruction.TYPE === 'Fork' && (instruction.show)">
        <div *ngFor="let branch of instruction.branches">
          <div class="p-l-md">
            <a class="m-l" (click)="collapse(branch)">
              <i class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (branch.show)}"></i>
              <i class="_600 inst-text">{{branch.id}}</i>
            </a>
            <span class="m-l-md" *ngIf="branch.order">
              <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
                <span *ngIf="branch.order">
                  <ng-container [ngTemplateOutlet]="itemTemplate"
                    [ngTemplateOutletContext]="{ $implicit: branch.order}"></ng-container>
                  <span class="order-count" *ngIf="orders  && orders.size - 1 > 0">
                    <ng-container [ngTemplateOutlet]="itemTemplate2"
                      [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: branch.order}"></ng-container>
                  </span>
                </span>
              </div>
            </span>
            <div class="p-l" *ngIf="branch.instructions && (branch.show)">
              <app-workflow-tree-structure [timezone]="timezone" [disabledDrag]="disabledDrag" [configuration]="branch"
                [jobs]="jobs" [orders]="orders" [expandAll]="expandAll"></app-workflow-tree-structure>
            </div>
          </div>
        </div>
      </div>
      <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
        id="{{instruction.positionString}}" *ngIf="instruction.TYPE === 'If' && (instruction.show)">
        <div *ngIf="instruction.then && instruction.then.instructions">
          <app-workflow-tree-structure [timezone]="timezone" [disabledDrag]="disabledDrag"
            [configuration]="instruction.then" [jobs]="jobs" [orders]="orders" [expandAll]="expandAll">
          </app-workflow-tree-structure>
          <div class="p-l-md">
            <a class="m-l" *ngIf="instruction.else" (click)="collapse(instruction.else)">
              <i class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (instruction.else.show)}"></i>
              <span class="_600 inst-text">Else</span>
            </a>
            <span class="m-l-md" *ngIf="instruction.else && (instruction.else.order)">
              <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
                <span *ngIf="instruction.else.order">
                  <ng-container [ngTemplateOutlet]="itemTemplate"
                    [ngTemplateOutletContext]="{ $implicit: instruction.else.order }"></ng-container>
                  <span class="order-count" *ngIf="orders && orders.size - 1 > 0">
                    <ng-container [ngTemplateOutlet]="itemTemplate2"
                      [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.else.order}">
                    </ng-container>
                  </span>
                </span>
              </div>
            </span>
            <div class="p-l" *ngIf="instruction.else && (instruction.else.show)">
              <app-workflow-tree-structure [timezone]="timezone" [disabledDrag]="disabledDrag"
                [configuration]="instruction.else" [jobs]="jobs" [orders]="orders" [expandAll]="expandAll"
                *ngIf="instruction.else.instructions"></app-workflow-tree-structure>
            </div>
          </div>
        </div>
      </div>
      <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
        id="{{instruction.positionString}}" *ngIf="instruction.TYPE === 'Try' && (instruction.show)">
        <app-workflow-tree-structure [timezone]="timezone" [disabledDrag]="disabledDrag" [configuration]="instruction"
          [jobs]="jobs" [orders]="orders" [expandAll]="expandAll" *ngIf="instruction.instructions">
        </app-workflow-tree-structure>
        <div class="p-l-md" *ngIf="instruction.catch && instruction.catch.instructions">
          <a class="m-l" (click)="collapse(instruction.catch)">
            <i class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (instruction.catch.show)}"></i>
            <span class="_600 inst-text" translate>workflow.label.catch</span>
          </a>
          <span class="m-l-md" *ngIf="(instruction.catch.order)">
            <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
              <span *ngIf="instruction.catch.order">
                <ng-container [ngTemplateOutlet]="itemTemplate"
                  [ngTemplateOutletContext]="{ $implicit: instruction.catch.order}"></ng-container>
                <span class="order-count" *ngIf="orders && orders.size - 1 > 0">
                  <ng-container [ngTemplateOutlet]="itemTemplate2"
                    [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.catch.order}">
                  </ng-container>
                </span>
              </span>
            </div>
          </span>
          <div class="m-l" *ngIf="(instruction.catch.show)">
            <app-workflow-tree-structure [timezone]="timezone" [disabledDrag]="disabledDrag"
              [configuration]="instruction.catch" [jobs]="jobs" [orders]="orders" [expandAll]="expandAll"
              *ngIf="instruction.catch.instructions"></app-workflow-tree-structure>
          </div>
        </div>
      </div>
      <div [ngClass]="{'drop-area' : instruction.enabled, 'drop-highlight' : instruction.enabled && disabledDrag}"
        id="{{instruction.positionString}}"
        *ngIf="(instruction.TYPE === 'Retry' || instruction.TYPE === 'Cycle' || instruction.TYPE === 'Lock' || instruction.TYPE === 'StickySubagent' || instruction.TYPE === 'ForkList' ||  instruction.TYPE === 'ConsumeNotices') && (instruction.show)">
        <div>
          <app-workflow-tree-structure [timezone]="timezone" [disabledDrag]="disabledDrag" [configuration]="instruction"
            [jobs]="jobs" [orders]="orders" [expandAll]="expandAll" *ngIf="instruction.instructions">
          </app-workflow-tree-structure>
        </div>
      </div>
      <div id="{{instruction.join.unique}}" *ngIf="instruction.join"
        [ngClass]="{'drop-area': instruction.join.enabled}">
        <span class="inst-text">
          <span class="_600">{{'workflow.label.join' | translate}}</span>
        </span>
        <span class="m-l-md" *ngIf="instruction.join.order">
          <div [ngClass]="disabledDrag ? 'inline' : 'draggable'" [draggable]="!disabledDrag">
            <span *ngIf="instruction.join.order">
              <ng-container [ngTemplateOutlet]="itemTemplate"
                [ngTemplateOutletContext]="{ $implicit: instruction.join.order}"></ng-container>
              <span class="order-count" *ngIf="orders && orders.size - 1 > 0">
                <ng-container [ngTemplateOutlet]="itemTemplate2"
                  [ngTemplateOutletContext]="{ $implicit: orders, currentOrder: instruction.join.order}"></ng-container>
              </span>
            </span>
          </div>
        </span>
      </div>
    </li>
  </ul>
</div>
