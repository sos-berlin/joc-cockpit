<ng-template #itemTemplate let-order>
  <ng-template #contentTemplate>
    <div class="p-l-sm">
      <span translate> order.label.state </span>:
      <span class="_600"> {{order.state._text |  translate}}</span>
    </div>
    <div class="p-l-sm" *ngIf="order.lastOutcome">
        <span translate> order.label.lastOutcome </span>:
        <span class="_600" >{{order.lastOutcome.TYPE}}</span>
<!--      <div class="p-l-sm">
        <span class="_600" >{{order.lastOutcome.namedValues |  json}}</span>
      </div>-->
    </div>
    <div *ngIf="order.scheduledFor">
      <span translate> order.label.scheduledFor </span>:
      <span class="_600" >{{order.scheduledFor | stringToDate}}</span>
    </div>
  </ng-template>
  <app-order-action [order]="order" [schedulerId]="schedulerId" [permission]="permission"
                    [preferences]="preferences"></app-order-action>
  <span [nz-tooltip]="contentTemplate">
    <i class="fa fa-circle p-r-s" [ngClass]="coreService.getColor(order.state.severity, 'text')"></i>
    {{order.orderId}}
  </span>
</ng-template>
<div *ngFor="let instruction of configuration.instructions">
  <ul style="margin-bottom: 0">
    <li >
      <a class="hover"
        *ngIf="instruction.TYPE === 'Fork' || instruction.TYPE === 'If' || instruction.TYPE === 'Try' || instruction.TYPE === 'Retry'">
        <i (click)="collapse(instruction)" class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (instruction.show || expandAll)}"></i>
        <i class="_600">{{instruction.TYPE}}</i>
        <span class="expand-collapse-btn">
          <i class="fa fa-lg fa-angle-double-down" (click)="expandNode(instruction)"></i>
          <i class="fa fa-lg fa-angle-double-up p-l-xs" (click)="collapseNode(instruction)"></i>
        </span>
        <span class="m-l" *ngIf="instruction.orders && instruction.orders.length> 0">
          <ng-template ngFor let-order [ngForOf]="instruction.orders | slice:0:3">
            <ng-container [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{ $implicit: order}"></ng-container>
          </ng-template>
          <span class="remaining-order-count" (click)="showOrders(instruction)" *ngIf="instruction.orders.length > 3">
            <i class="remaining-order-count-i">Show other</i>
            <span class="remaining-order-count-span">{{instruction.orders.length - 3}}</span>
          </span>
        </span>
        <span class="order-count" (click)="showOrders(instruction)" *ngIf="instruction.count > 0 && (!instruction.show && !expandAll)">{{instruction.count}}</span>
      </a>
      <div *ngIf="instruction.TYPE === 'Job' || instruction.TYPE === 'Fail' || instruction.TYPE === 'Finish' || instruction.TYPE === 'Publish' || instruction.TYPE === 'Await'">
        {{instruction.jobName || instruction.TYPE}}
        <span class="m-l-md" *ngIf="instruction.orders && instruction.orders.length> 0">
         <ng-template ngFor let-order [ngForOf]="instruction.orders | slice:0:3">
            <ng-container [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{ $implicit: order}"></ng-container>
          </ng-template>
          <span class="remaining-order-count" (click)="showOrders(instruction)" *ngIf="instruction.orders.length > 3">
            <i class="remaining-order-count-i">Show other</i>
            <span class="remaining-order-count-span">{{instruction.orders.length - 3}}</span>
          </span>
        </span>
      </div>
      <div *ngIf="instruction.TYPE === 'Fork' && (instruction.show || expandAll)">
        <div *ngFor="let branch of instruction.branches">
          <div class="p-l-md">
            <a class="m-l" (click)="collapse(branch)">
              <i class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (branch.show || expandAll)}"></i>
              <i class="_600">{{branch.id}}</i>
            </a>
            <span class="m-l-md" *ngIf="branch.orders && branch.orders.length> 0">
              <ng-template ngFor let-order [ngForOf]="branch.orders | slice:0:3">
                  <ng-container [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{ $implicit: order}"></ng-container>
              </ng-template>
              <span class="remaining-order-count" (click)="showOrders(branch)" *ngIf="branch.orders.length > 3">
                <i class="remaining-order-count-i">Show other</i>
                <span class="remaining-order-count-span">{{branch.orders.length - 3}}</span>
              </span>
            </span>
            <span class="order-count" (click)="showOrders(branch)" *ngIf="branch.count > 0 && (!branch.show && !expandAll)"> {{branch.count}}</span>
            <div class="p-l" *ngIf="branch.instructions && (branch.show || expandAll)">
              <app-type [permission]="permission" [preferences]="preferences" [schedulerId]="schedulerId"
                        [configuration]="branch" [expandAll]="expandAll"></app-type>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="instruction.TYPE === 'If' && (instruction.show || expandAll)">
        <div *ngIf="instruction.then && instruction.then.instructions">
          <app-type [permission]="permission" [preferences]="preferences" [schedulerId]="schedulerId"
                    [configuration]="instruction.then" [expandAll]="expandAll"></app-type>
          <div class="p-l-md">
            <a class="m-l" *ngIf="instruction.else" (click)="collapse(instruction.else)">
              <i class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (instruction.else.show || expandAll)}"></i>
              <i class="_600">Else</i>
            </a>
            <span class="m-l-md" *ngIf="instruction.else.orders && instruction.else.orders.length>0">
              <ng-template ngFor let-order [ngForOf]="instruction.else.orders | slice:0:3">
                  <ng-container [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{ $implicit: order }"></ng-container>
              </ng-template>
              <span class="remaining-order-count" (click)="showOrders(instruction.else)" *ngIf="instruction.else.orders.length > 3">
                <i class="remaining-order-count-i">Show other</i>
                <span class="remaining-order-count-span">{{instruction.else.orders.length - 3}}</span>
              </span>
            </span>
            <span class="order-count" (click)="showOrders(instruction.else)" *ngIf="instruction.else.count > 0 && (!instruction.else.show && !expandAll)">{{instruction.else.count}}</span>
            <div class="p-l" *ngIf="instruction.else && (instruction.else.show || expandAll)">
              <app-type [permission]="permission" [preferences]="preferences" [schedulerId]="schedulerId"
                        [configuration]="instruction.else" [expandAll]="expandAll" *ngIf="instruction.else.instructions"></app-type>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="instruction.TYPE === 'Try' && (instruction.show || expandAll)">
          <app-type [permission]="permission" [preferences]="preferences" [schedulerId]="schedulerId"
                    [configuration]="instruction" [expandAll]="expandAll" *ngIf="instruction.instructions"></app-type>
          <div class="p-l-md">
            <a class="m-l" *ngIf="instruction.catch" (click)="collapse(instruction.catch)">
              <i class="fa fa-plus pr-2" [ngClass]="{'fa-minus' : (instruction.catch.show || expandAll)}"></i>
              <i class="_600">Catch</i>
            </a>
            <span class="m-l-md" *ngIf="instruction.catch.orders && instruction.catch.orders.length>0">
              <ng-template ngFor let-order [ngForOf]="instruction.catch.orders | slice:0:3">
                  <ng-container [ngTemplateOutlet]="itemTemplate" [ngTemplateOutletContext]="{ $implicit: order}"></ng-container>
              </ng-template>
              <span class="remaining-order-count" (click)="showOrders(instruction.catch)" *ngIf="instruction.catch.orders.length > 3">
                <i class="remaining-order-count-i">Show other</i>
                <span class="remaining-order-count-span">{{instruction.catch.orders.length - 3}}</span>
              </span>
            </span>
            <span class="order-count" (click)="showOrders(instruction.catch)" *ngIf="instruction.catch.count > 0 && (!instruction.catch.show && !expandAll)">{{instruction.catch.count}}</span>
            <div class="m-l" *ngIf="instruction.catch && (instruction.catch.show || expandAll)">
              <app-type [permission]="permission" [preferences]="preferences" [schedulerId]="schedulerId"
                        [configuration]="instruction.catch" [expandAll]="expandAll" *ngIf="instruction.catch.instructions"></app-type>
            </div>
          </div>
      </div>
      <div *ngIf="instruction.TYPE === 'Retry' && (instruction.show || expandAll)">
        <div>
          <app-type [permission]="permission" [preferences]="preferences" [schedulerId]="schedulerId"
                    [configuration]="instruction" [expandAll]="expandAll" *ngIf="instruction.instructions"></app-type>
        </div>
      </div>
    </li>
  </ul>
</div>
<div id="rightSideBar" *ngIf="sideBar.isVisible" class="slideInRight">
  <div class="close-btn" (click)="sideBar.isVisible = false"></div>
  <div class="text-center m-b text"><i class="tree-icon icon-orders-icon"></i>&nbsp;
    <span class="_600 b-b p-b-sm m-l-sm" translate>order.label.orders</span>
  </div>
  <div class="p-a-sm">
    <nz-table
      #ajaxTable
      [nzSize]="'small'"
      [nzBordered]="true"
      [nzShowPagination]="false"
      [nzData]="sideBar.orders"
      [nzPageSize]="sideBar.orders.length"
    >
      <thead>
      <tr>
        <th class="menu" rowspan="2"><span translate>common.label.action</span></th>
        <th><span class="p-r-xs" translate>order.label.orderId</span></th>
        <th><span class="p-r-xs" translate>order.label.state</span></th>
        <th><span class="p-r-xs" translate>order.label.scheduledFor</span></th>
        <th><span class="p-r-xs" translate>order.label.lastOutcome</span></th>
      </tr>
      </thead>
      <tbody>
      <ng-template ngFor let-order
                   [ngForOf]="ajaxTable.data">
        <tr>
          <td>
            <app-order-action [order]="order" [schedulerId]="schedulerId" [permission]="permission"
                              [preferences]="preferences"></app-order-action>
          </td>
          <td>
            <span class="show-in-single-line">
              <i class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs" *ngIf="!order.show"
                 (click)="showPanelFuc(order)"></i>
              <i class="cursor fa fa-caret-up fa-lg p-l-xs p-r-xs" *ngIf="order.show" (click)="order.show = false"></i>
              <a class="text-dark">{{order.orderId}}</a>
              <span *ngIf="order.title">-</span>
              <i class="text-muted">{{order.title}}</i>
            </span>
          </td>
          <td>
            <a class="label" *ngIf="order.state" [ngClass]="coreService.getColor(order.state.severity, 'bg')"
               [innerHtml]="order.state._text | translate"></a>
          </td>
          <td>{{order.scheduledFor | stringToDate}}</td>
          <td>
            <span *ngIf="order.lastOutcome">
              {{order.lastOutcome.TYPE | translate}}
            </span>
          </td>
        </tr>
        <tr *ngIf="order.show">
          <td colspan="7">
            <div *ngIf="order.arguments && order.arguments.length > 0">
              <div *ngFor="let argu of order.arguments"
                   class="plan-varibales pt-1 pb-1">
                <span>{{argu.name}} : {{argu.value}}</span>
              </div>
            </div>
            <div class="p-l" *ngIf="!order.arguments || (order.arguments && order.arguments.length === 0)">
              <span translate>common.message.noDataAvailable</span>
            </div>
          </td>
        </tr>
      </ng-template>
      </tbody>
    </nz-table>
  </div>
</div>
