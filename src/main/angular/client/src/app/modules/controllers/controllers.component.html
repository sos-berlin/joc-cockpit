<div class="white box-shadow sub-header">
  <div class="row">
    <div class="col-md-12">
      <div class="padding">
        <div class="text-right ">
          <div class="pull-left">
            <app-breadcrumbs></app-breadcrumbs>
          </div>
          @if (permission.joc && permission.joc.administration.controllers.manage) {
            <div class="inline">
              @if (object.mapOfCheckedId.size === 0 && object.mapOfCheckedId2.size === 0 && object.mapOfCheckedId3.size === 0 && isJOCActive) {
                <ng-container>
                  <div class="btn-group">
                    <button (click)="loadAgents('ALL')" [ngClass]="{'btn-primary': agentsFilters.filter.state=='ALL'}"
                            class="btn btn-grey btn-sm" translate>agent.button.allAgent
                    </button>
                    <button (click)="loadAgents('IN_SYNC')" [ngClass]="{'btn-primary': agentsFilters.filter.state=='IN_SYNC'}"
                            class="btn btn-grey btn-sm text-capitalize" translate>IN_SYNC
                    </button>
                    <button (click)="loadAgents('NOT_IN_SYNC')" [ngClass]="{'btn-primary': agentsFilters.filter.state=='NOT_IN_SYNC'}"
                            class="btn btn-grey btn-sm text-capitalize" translate>NOT_IN_SYNC
                    </button>
                    <button (click)="loadAgents('NOT_DEPLOYED')"
                            [ngClass]="{'btn-primary': agentsFilters.filter.state=='NOT_DEPLOYED'}"
                            class="btn btn-grey btn-sm text-capitalize" translate>NOT_DEPLOYED
                    </button>
                    <button (click)="loadAgents('UNKNOWN')" [ngClass]="{'btn-primary': agentsFilters.filter.state=='UNKNOWN'}"
                            class="btn btn-grey btn-sm text-capitalize" translate>agent.button.unknown
                    </button>
                  </div>
                  @if (isJOCActive) {
                    <button (click)="addController()" class="btn btn-grey btn-sm m-l-12">
                      <i class="fa fa-plus"></i>&nbsp;
                      <span translate>controller.button.newController</span>
                    </button>
                  }
                </ng-container>
              }

              @if ((object.mapOfCheckedId.size>0 || object.mapOfCheckedId2.size > 0) && object.mapOfCheckedId3.size === 0) {
                <div class="show-inline">
                  <button (click)="deployAll()" class="btn btn-grey btn-sm m-l-12" translate>inventory.button.deploy</button>
                  <button (click)="revokeAll()" class="btn btn-grey btn-sm m-l-12" translate>agent.button.revoke</button>
                  <button (click)="createToken(null)" class="btn btn-grey btn-sm m-l-12" translate>
                    agent.button.createToken
                  </button>
                  @if (object.mapOfCheckedId2.size == 0) {
                    <button (click)="disableAll()" class="btn btn-grey btn-sm m-l-12"
                            translate>agent.button.disable
                    </button>
                  }
                  @if (object.mapOfCheckedId2.size == 0) {
                    <button (click)="enableAll()" class="btn btn-grey btn-sm m-l-12"
                            translate>agent.button.enable
                    </button>
                  }
                  @if (object.mapOfCheckedId2.size == 0) {
                    <button (click)="hideAll()" class="btn btn-grey btn-sm m-l-12"
                            translate>agent.button.hide
                    </button>
                  }
                  @if (object.mapOfCheckedId2.size == 0) {
                    <button (click)="showAll()" class="btn btn-grey btn-sm m-l-12"
                            translate>agent.button.show
                    </button>
                  }
                  @if (object.mapOfCheckedId2.size == 0) {
                    <button (click)="resetAll()" class="btn btn-grey btn-sm m-l-12"
                            translate>agent.button.reset
                    </button>
                  }
                  @if (object.mapOfCheckedId2.size == 0) {
                    <button (click)="resetAll(true)" class="btn btn-grey btn-sm m-l-12" translate>agent.button.resetForced
                    </button>
                  }
                  <button (click)="deleteAll()" class="btn btn-grey btn-sm m-l-12" translate>common.button.delete</button>
                  <button (click)="exportBulkAgents()" class="btn btn-grey btn-sm m-l-12" translate>common.button.export</button>
                </div>
              }
              @if (object.mapOfCheckedId3.size>0 && (object.mapOfCheckedId.size == 0 && object.mapOfCheckedId2.size == 0)) {
                <div class="show-inline">
                  <button (click)="disableAllSubAgent()" class="btn btn-grey btn-sm m-l-12" translate>agent.button.disable
                  </button>
                  <button (click)="enableAllSubAgent()" class="btn btn-grey btn-sm m-l-12" translate>agent.button.enable
                  </button>
                  <button (click)="resetAllSubagent()" class="btn btn-grey btn-sm m-l-12" translate>agent.button.reset
                  </button>
                  <button (click)="resetAllSubagent(true)" class="btn btn-grey btn-sm m-l-12" translate>
                    agent.button.resetForced
                  </button>
                  <button (click)="deleteAllSubagent()" class="btn btn-grey btn-sm m-l-12" translate>common.button.delete
                  </button>
                </div>
              }
            </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>
<div class="sub-link">
  <div class="row">
    <div class="col-md-12 text-right">
      <button (click)="collapseDetails()"
              class="btn btn-sm btn-grey pull-right m-l-12" nz-tooltip="{{'common.tooltip.collapseDetails' | translate}}">
        <i class="fa fa-compress text"></i>
      </button>
      <button (click)="expandDetails()"
              class="btn btn-sm btn-grey pull-right m-l-12" nz-tooltip="{{'common.tooltip.expandDetails' | translate}}">
        <i class="fa fa-expand text"></i>
      </button>
      <div class="search-box-field pull-right">
        <label>
          <input (keyup)="searchInResult()" [(ngModel)]="agentsFilters.searchText" placeholder="{{'common.placeholder.search' | translate}}"
                 type="search">
        </label>
        <i (click)="agentsFilters.searchText = '';searchInResult()" [hidden]="!agentsFilters.searchText"
           class="fa fa-times search-close"></i>
      </div>
    </div>
  </div>
</div>
<div class="scroll-y max-ht">
  <div class="padding p-b-0">
    <div class="row m-b">
      <div class="col-md-12">
        <div class="box p-a-sm text-overflow">
          <div appResizable class="resizable" id="mainContainer">
            @for (controller of controllers; track controller.controllerId; let id = $index) {
              <div [ngClass]="{'p-b-md': id == controllers.length-1}" class="box-body p-b-0">
                @if (!currentSecurityLevel || currentSecurityLevel === controller.securityLevel) {
                  <ng-container>
                    <div class="row">
                      <div class="col-sm-12">
                        @if (permission.joc && permission.joc.administration.controllers.manage) {
                          <div class="btn-group dropdown pull-left m-r-sm">
                            <button (nzVisibleChange)="onVisible($event)" [nzDropdownMenu]="menu" class="btn-drop more-option-h"
                                    nz-dropdown nzTrigger="click" type="button">
                              <i class="fa fa-ellipsis-h"></i></button>
                            <nz-dropdown-menu #menu="nzDropdownMenu" role="menu">
                              <ul nz-menu>
                                @if (isJOCActive) {
                                  <li (click)="editController(controller.controllerId)" nz-menu-item>
                                    <a translate>common.button.edit</a>
                                  </li>
                                }
                                <li (click)="addAgent(controller)" nz-menu-item>
                                  <a translate>agent.button.addAgent</a>
                                </li>
                                @if (hasLicense) {
                                  <li (click)="addClusterAgent(controller)" nz-menu-item>
                                    <a translate>agent.button.addClusterAgent</a>
                                  </li>
                                }
                                @if (permission.joc.administration.certificates.manage) {
                                  <li (click)="createToken(controller)" nz-menu-item>
                                    <a translate>agent.button.createToken</a>
                                  </li>
                                }
                                <li nz-menu-divider></li>
                                <li (click)="exportAgents(controller)" nz-menu-item>
                                  <a translate>agent.button.exportAgentConfiguration</a>
                                </li>
                                <li (click)="importAgents(controller)" nz-menu-item>
                                  <a translate>agent.button.importAgentConfiguration</a>
                                </li>
                                <li nz-menu-divider></li>
                                <li (click)="deleteController(controller.controllerId)" class="bg-hover-color" nz-menu-item>
                                  <a translate>common.button.delete</a>
                                </li>
                              </ul>
                            </nz-dropdown-menu>
                          </div>
                        }
                        <h5 class="text-dark">
                          @if (!currentSecurityLevel || currentSecurityLevel === controller.securityLevel) {
                            <a (click)="editController(controller.controllerId)">
                              @if (controller.compatibility) {
                                <i [ngClass]="controller.compatibility === 'COMPATIBLE' ? 'text-success' : controller.compatibility === 'NOT_COMPATIBLE' ? 'fa-exclamation-triangle text-danger' : 'fa-exclamation-triangle text-warn'"
                                   [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="controller.compatibility | translate"
                                   class="fa fa-check"></i>
                              }
                              &nbsp;{{controller.controllerId}}
                            </a>
                          }
                          @if (currentSecurityLevel && currentSecurityLevel !== controller.securityLevel) {
                            <span>{{controller.controllerId}}</span>
                          }
                          @if (coreService.preferences.controllers.has(controller.controllerId)) {
                            <i (click)="collapse(controller.controllerId);" class="cursor fa fa-caret-up m-l-xs"></i>
                          }
                          @if (!coreService.preferences.controllers.has(controller.controllerId)) {
                            <i (click)="expand(controller.controllerId);getAgents(controller, null)" class="cursor fa fa-caret-down m-l-xs"></i>
                          }
                          @if (controller.token && controller.token.validUntil) {
                            <span class="text-sm pull-right m-r-sm">
                              <span translate>agent.label.validityDate</span>:
                              <i class="text-muted p-l-xs">{{controller.token.validUntil | stringToDate}}</i>
                              <a [nzPopoverContent]="contentTemplate" class="primary-text-hover-color p-l-sm"
                                 nz-popover nzPopoverTrigger="click"><i class="fa fa-key"></i></a>
                              <ng-template #contentTemplate>
                                <div>
                                  <b translate>agent.label.url</b> :
                                  <span>{{controller.token.URI}}</span>
                                </div>
                                <div>
                                  <b translate>agent.label.token</b> :
                                  <span>{{controller.token.UUID}} <i (click)="showCopyMessage()" [cbContent]="controller.token.UUID"
                                                                     class="cursor primary-text-hover-color p-l-sm fa fa-copy"
                                                                     ngxClipboard></i></span>
                                </div>
                                @if (controller.token.URI2) {
                                  <div class="m-t-sm">
                                    <b translate>agent.label.url</b> :
                                    <span>{{controller.token.URI2}}</span>
                                  </div>
                                }
                                @if (controller.token.URI2) {
                                  <div>
                                    <b translate>agent.label.token</b> :
                                    <span>{{controller.token.UUID2}} <i (click)="showCopyMessage()" [cbContent]="controller.token.UUID2"
                                                                        class="cursor primary-text-hover-color p-l-sm fa fa-copy"
                                                                        ngxClipboard></i></span>
                                  </div>
                                }
                              </ng-template>
                            </span>
                          }
                        </h5>
                      </div>
                    </div>
                    @if (coreService.preferences.controllers.has(controller.controllerId)) {
                      <div class="row">
                        <div class="col-md-12">
                          <div class="p-a-sm p-b-0">
                            <div class="p-b-xs" translate>
                              agent.label.agents
                              @if (coreService.preferences.controllers.has(controller.controllerId+ '$standalone$')) {
                                <i (click)="collapse(controller.controllerId + '$standalone$');" class="cursor fa fa-caret-down m-l-xs"></i>
                              }
                              @if (!coreService.preferences.controllers.has(controller.controllerId+ '$standalone$')) {
                                <i (click)="expand(controller.controllerId+'$standalone$');" class="cursor fa fa-caret-up m-l-xs"></i>
                              }
                            </div>
                            @if (!coreService.preferences.controllers.has(controller.controllerId+ '$standalone$')) {
                              <nz-table
                                #ajaxTable
                                [nzBordered]="true" [nzData]="controller.filteredAgents | orderBy: controller.sortBy: controller.reverse" [nzFrontPagination]="false"
                                [nzLoading]="controller.loading"
                                [nzShowPagination]="false" nzSize="small">
                                <thead>
                                <tr>
                                  @if (permission.joc && permission.joc.administration.controllers.manage) {
                                    <th [(nzChecked)]="controller.checked"
                                        [nzDisabled]="object.mapOfCheckedId3.size > 0"
                                        [nzIndeterminate]="controller.indeterminate"
                                        [nzShowCheckbox]="true"
                                        (nzCheckedChange)="checkAll($event, controller)"
                                        class="chk"
                                    ></th>
                                  }
                                  @if (permission.joc && permission.joc.administration.controllers.manage) {
                                    <th class="menu"><span translate>common.label.action</span></th>
                                  }
                                  <th (click)="sort(controller, 'agentId')">
                                    <a><span class="p-r-xs" translate>agent.label.agentId</span>
                                      @if (controller.sortBy == 'agentId' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'agentId' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'agentName')">
                                    <a><span class="p-r-xs" translate>agent.label.agentName</span>
                                      @if (controller.sortBy == 'agentName' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'agentName' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'agentNameAliases')">
                                    <a><span class="p-r-xs" translate>agent.label.agentNameAliases</span>
                                      @if (controller.sortBy == 'agentNameAliases' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'agentNameAliases' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'url')">
                                    <a><span class="p-r-xs" translate>agent.label.url</span>
                                      @if (controller.sortBy == 'url' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'url' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'version')">
                                    <a><span class="p-r-xs" translate>dashboard.label.version</span>
                                      @if (controller.sortBy == 'version' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'version' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'processLimit')">
                                    <a><span class="p-r-xs" translate>agent.label.processLimit</span>
                                      @if (controller.sortBy == 'processLimit' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'processLimit' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'syncState._text')" nzWidth="100px">
                                    <a><span class="p-r-xs" translate>common.label.status</span>
                                      @if (controller.sortBy == 'syncState._text' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'syncState._text' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'hidden')" nzWidth="100px">
                                    <a><span class="p-r-xs" translate>agent.label.hidden</span>
                                      @if (controller.sortBy == 'hidden' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'hidden' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'disabled')" nzWidth="100px">
                                    <a><span class="p-r-xs" translate>agent.label.disabled</span>
                                      @if (controller.sortBy == 'disabled' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'disabled' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'validityDate')" nzWidth="150px">
                                    <a><span class="p-r-xs" translate>agent.label.validityDate</span>
                                      @if (controller.sortBy == 'validityDate' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'validityDate' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'token.validUntil')" nzWidth="140px">
                                    <a><span class="p-r-xs" translate>agent.label.oneTimeToken</span>
                                      @if (controller.sortBy == 'token.validUntil' && !controller.reverse) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy == 'token.validUntil' && controller.reverse) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th nzWidth="100px"><span class="p-r-xs" translate>encipherment.label.certificates</span></th>
                                </tr>
                                </thead>
                                <tbody (cdkDropListDropped)="agentsReordering($event, controller.filteredAgents)" cdkDropList>
                                  @for (agent of ajaxTable.data; track agent.agentId) {
                                    <tr [ngClass]="{'disabled-row': agent.disabled}" cdkDrag class="cursor move-on-hover">
                                      @if (permission.joc && permission.joc.administration.controllers.manage) {
                                        <td class="chk" [nzChecked]="object.mapOfCheckedId.has(agent.agentId)"
                                            [nzDisabled]="object.mapOfCheckedId3.size > 0"
                                            [nzShowCheckbox]="true"
                                            (nzCheckedChange)="onItemChecked(controller, agent, $event)"
                                        >
                                          <div cdkDragHandle
                                               class="pos-abt move-icon text-16 cur-m t-1" style="left: -1px;overflow: hidden;max-width: 12px">
                                            <i aria-hidden="true" class="fa fa-bars"></i>
                                          </div>
                                        </td>
                                      }
                                      @if (permission.joc && permission.joc.administration.controllers.manage) {
                                        <td class="menu">
                                          <div class="btn-group dropdown pull-left m-r-sm">
                                            <button (nzVisibleChange)="onVisible($event)" [nzDisabled]="controller.checked || controller.indeterminate"
                                                    [nzDropdownMenu]="option" class="btn-drop more-option-h"
                                                    nz-dropdown
                                                    nzTrigger="click" type="button"><i
                                              class="fa fa-ellipsis-h"></i></button>
                                            <nz-dropdown-menu #option="nzDropdownMenu" role="menu">
                                              <ul nz-menu>
                                                <li (click)="editAgent(agent, controller)" nz-menu-item>
                                                  <a translate>common.button.edit</a>
                                                </li>
                                                <li (click)="deployAgent(agent, controller, true)" nz-menu-item>
                                                  <a translate>inventory.button.deploy</a>
                                                </li>
                                                <li (click)="revoke(agent, controller, true)" nz-menu-item>
                                                  <a translate>agent.button.revoke</a>
                                                </li>
                                                <li (click)="createToken(controller, agent)" nz-menu-item>
                                                  <a translate>agent.button.createToken</a>
                                                </li>
                                                <li (click)="addCertificateToAgent(controller, agent)" nz-menu-item>
                                                  <a translate>agent.button.addEnciphermentCertificate</a>
                                                </li>
                                                <li nz-menu-divider></li>
                                                @if (!agent.disabled) {
                                                  <li (click)="disableEnableSubagent(agent, controller, false, true)" nz-menu-item>
                                                    <a translate>agent.button.disable</a>
                                                  </li>
                                                }
                                                @if (agent.disabled) {
                                                  <li (click)="disableEnableSubagent(agent, controller, true, true)" nz-menu-item>
                                                    <a translate>agent.button.enable</a>
                                                  </li>
                                                }
                                                @if (!agent.hidden) {
                                                  <li (click)="hideAgent(agent, controller)" nz-menu-item>
                                                    <a translate>agent.button.hide</a>
                                                  </li>
                                                }
                                                @if (agent.hidden) {
                                                  <li (click)="showAgent(agent, controller)" nz-menu-item>
                                                    <a translate>agent.button.show</a>
                                                  </li>
                                                }
                                                <li (click)="resetAgent(agent, controller)" nz-menu-item>
                                                  <a translate>agent.button.reset</a>
                                                </li>
                                                <li (click)="resetAgent(agent, controller, true)" nz-menu-item>
                                                  <a translate>agent.button.resetForced</a>
                                                </li>
                                                <li nz-menu-divider></li>
                                                <li (click)="exportBulkAgents(agent.agentId)" nz-menu-item>
                                                  <a translate>common.button.export</a>
                                                </li>
                                                <li nz-menu-divider></li>
                                                <li (click)="removeAgent(agent, controller)" class="bg-hover-color" nz-menu-item>
                                                  <a translate>common.button.delete</a>
                                                </li>
                                              </ul>
                                            </nz-dropdown-menu>
                                          </div>
                                        </td>
                                      }
                                      <td (click)="editAgent(agent, controller)">
                                        <span [innerHtml]="agent.agentId | highlight : agentsFilters.searchText"></span>
                                        @if (agent.title) {
                                          <i> - </i>
                                        }
                                        <i class="text-muted">{{agent.title}}</i>
                                      </td>
                                      <td (click)="editAgent(agent, controller)"><span [innerHtml]="agent.agentName | highlight : agentsFilters.searchText"></span></td>
                                      <td (click)="editAgent(agent, controller)" [nzBreakWord]><span
                                        [innerHtml]="agent.agentNameAliases || '-'"></span></td>
                                      <td (click)="editAgent(agent, controller)"><span [innerHtml]="agent.url | highlight : agentsFilters.searchText"></span></td>
                                      <td (click)="editAgent(agent, controller)">
                                        @if (agent.compatibility) {
                                          <i [ngClass]="agent.compatibility === 'COMPATIBLE' ? 'text-success' : agent.compatibility === 'NOT_COMPATIBLE' ? 'fa-exclamation-triangle text-danger' : 'fa-exclamation-triangle text-warn'"
                                             [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="agent.compatibility | translate"
                                             class="fa fa-check"></i>&nbsp;
                                        }
                                        <span [innerHtml]="agent.version"></span>
                                      </td>
                                      <td>{{agent.processLimit}}</td>
                                      <td (click)="editAgent(agent, controller)">
                                        @if (agent.syncState) {
                                          <label [innerHtml]="agent.syncState._text | translate"
                                                 [ngClass]="coreService.getColor(agent.syncState.severity, 'bg')"
                                                 class="label"></label>
                                        }
                                      </td>
                                      <td
                                        (click)="editAgent(agent, controller)">{{(agent.hidden ? 'common.label.yes' : 'common.label.no') | translate}}</td>
                                      <td
                                        (click)="editAgent(agent, controller)">{{(agent.disabled ? 'common.label.yes' : 'common.label.no') | translate}}</td>
                                      <td>
                                        @if (!agent.token) {
                                          <span>-</span>
                                        }
                                        @if (agent.token) {
                                          <span>{{agent.token.validUntil | stringToDate}}</span>
                                        }
                                      </td>
                                      <td>
                                        @if (agent.token) {
                                          <div>
                                            <a [nzPopoverContent]="contentTemplate" class="primary-text-hover-color" nz-popover
                                               nzPopoverTrigger="click"><i class="fa fa-key"></i></a>
                                            <ng-template #contentTemplate>
                                              <b translate>agent.label.token</b> :
                                              <span>{{agent.token.UUID}} <i (click)="showCopyMessage()" [cbContent]="agent.token.UUID"
                                                                            class="cursor primary-text-hover-color p-l-sm fa fa-copy"
                                                                            ngxClipboard></i></span>
                                            </ng-template>
                                          </div>
                                        }
                                        @if (!agent.token) {
                                          <span>-</span>
                                        }
                                      </td>
                                      <td (click)="showCertificateAliases(agent, 'standalone')">
                                        <a><i class="fa fa-list-alt"></i></a>
                                      </td>
                                    </tr>
                                  }
                                </tbody>
                              </nz-table>
                            }
                            @if (hasLicense) {
                              <div class="m-t p-b-xs" translate>
                                agent.label.agentGroups
                                @if (coreService.preferences.controllers.has(controller.controllerId+ '$cluster$')) {
                                  <i (click)="collapse(controller.controllerId + '$cluster$');" class="cursor fa fa-caret-down m-l-xs"></i>
                                }
                                @if (!coreService.preferences.controllers.has(controller.controllerId+ '$cluster$')) {
                                  <i (click)="expand(controller.controllerId+'$cluster$');" class="cursor fa fa-caret-up m-l-xs"></i>
                                }
                              </div>
                            }
                            @if (hasLicense && !coreService.preferences.controllers.has(controller.controllerId+ '$cluster$')) {
                              <nz-table
                                #agentClusterTable
                                [nzBordered]="true" [nzData]="controller.filteredAgentClusters | orderBy: controller.sortBy2: controller.reverse2" [nzFrontPagination]="false"
                                [nzLoading]="controller.isLoading"
                                [nzShowPagination]="false" nzSize="small">
                                <thead>
                                <tr>
                                  @if (permission.joc && permission.joc.administration.controllers.manage) {
                                    <th [(nzChecked)]="controller.checked2"
                                        [nzDisabled]="object.mapOfCheckedId3.size > 0"
                                        [nzIndeterminate]="controller.indeterminate2"
                                        [nzShowCheckbox]="true"
                                        (nzCheckedChange)="checkAll($event, controller, true)"
                                        class="chk"
                                    ></th>
                                  }
                                  <th class="menu"><span translate>common.label.action</span></th>
                                  <th (click)="sort(controller, 'agentId', true)">
                                    <a><span class="p-r-xs" translate>agent.label.agentId</span>
                                      @if (controller.sortBy2 == 'agentId' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'agentId' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'agentName', true)" nzWidth="15%">
                                    <a><span class="p-r-xs" translate>agent.label.agentName</span>
                                      @if (controller.sortBy2 == 'agentName' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'agentName' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'agentNameAliases', true)">
                                    <a><span class="p-r-xs" translate>agent.label.agentNameAliases</span>
                                      @if (controller.sortBy2 == 'agentNameAliases' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'agentNameAliases' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'version', true)">
                                    <a><span class="p-r-xs" translate>dashboard.label.version</span>
                                      @if (controller.sortBy2 == 'version' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'version' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'processLimit', true)">
                                    <a><span class="p-r-xs" translate>agent.label.processLimit</span>
                                      @if (controller.sortBy2 == 'processLimit' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'processLimit' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'syncState._text', true)" nzWidth="100px">
                                    <a><span class="p-r-xs" translate>common.label.status</span>
                                      @if (controller.sortBy2 == 'syncState._text' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'syncState._text' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'validityDate', true)" nzWidth="150px">
                                    <a><span class="p-r-xs" translate>agent.label.validityDate</span>
                                      @if (controller.sortBy2 == 'validityDate' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'validityDate' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                  <th (click)="sort(controller, 'token.validUntil', true)" nzWidth="140px">
                                    <a><span class="p-r-xs" translate>agent.label.oneTimeToken</span>
                                      @if (controller.sortBy2 == 'token.validUntil' && !controller.reverse2) {
                                        <i class="fa fa-caret-up "></i>
                                      }
                                      @if (controller.sortBy2 == 'token.validUntil' && controller.reverse2) {
                                        <i class="fa fa-caret-down "></i>
                                      }</a>
                                  </th>
                                </tr>
                                </thead>
                                <tbody (cdkDropListDropped)="clusterAgentsReordering($event, controller.filteredAgentClusters)"
                                       cdkDropList>
                                  @for (clusterAgent of agentClusterTable.data; track clusterAgent.agentId; let i = $index) {
                                    <ng-container>
                                      <tr [ngClass]="{'disabled-row': clusterAgent.disabled}" cdkDrag class="cursor move-on-hover">
                                        @if (permission.joc && permission.joc.administration.controllers.manage) {
                                          <td class="chk"
                                              [nzChecked]="object.mapOfCheckedId2.has(clusterAgent.agentId)" [nzDisabled]="object.mapOfCheckedId3.size > 0"
                                              [nzShowCheckbox]="true"
                                              (nzCheckedChange)="onItemChecked(controller, clusterAgent, $event, true)"
                                          >
                                            <div cdkDragHandle
                                                 class="pos-abt move-icon text-16 cur-m t-1" style="left: -1px;overflow: hidden;max-width: 12px">
                                              <i aria-hidden="true" class="fa fa-bars"></i>
                                            </div>
                                          </td>
                                        }
                                        <td class="menu">
                                          <div class="btn-group dropdown pull-left m-r-sm">
                                            <button (nzVisibleChange)="onVisible($event)" [nzDisabled]="controller.checked2 || controller.indeterminate2"
                                                    [nzDropdownMenu]="option"
                                                    class="btn-drop more-option-h" nz-dropdown
                                                    nzTrigger="click" type="button"><i class="fa fa-ellipsis-h"></i>
                                            </button>
                                            <nz-dropdown-menu #option="nzDropdownMenu" role="menu">
                                              <ul nz-menu>
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="editAgent(clusterAgent, controller, true)" nz-menu-item>
                                                    <a translate>common.button.edit</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="addSubagent(clusterAgent, controller)" nz-menu-item>
                                                    <a translate>agent.button.addSubagent</a>
                                                  </li>
                                                }
                                                <li (click)="navToController(controller.controllerId, clusterAgent.agentId)" nz-menu-item>
                                                  <a translate>agent.button.manageCluster</a>
                                                </li>
                                                @if (permission.joc.administration.certificates.manage) {
                                                  <li (click)="createToken(controller, clusterAgent)" nz-menu-item>
                                                    <a translate>agent.button.createToken</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li nz-menu-divider></li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="deployAgent(clusterAgent, controller)" nz-menu-item>
                                                    <a translate>inventory.button.deploy</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="revoke(clusterAgent, controller)" nz-menu-item>
                                                    <a translate>agent.button.revoke</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="resetAgent(clusterAgent, controller)" nz-menu-item>
                                                    <a translate>agent.button.reset</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="resetAgent(clusterAgent, controller, true)" nz-menu-item>
                                                    <a translate>agent.button.resetForced</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li nz-menu-divider></li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="exportBulkAgents(clusterAgent.agentId)" nz-menu-item>
                                                    <a translate>common.button.export</a>
                                                  </li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li nz-menu-divider></li>
                                                }
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <li (click)="removeAgent(clusterAgent, controller, true)" class="bg-hover-color" nz-menu-item>
                                                    <a translate>common.button.delete</a>
                                                  </li>
                                                }
                                              </ul>
                                            </nz-dropdown-menu>
                                          </div>
                                        </td>
                                        <td>
                                        <span class="show-in-single-line">
                                          @if (!clusterAgent.show) {
                                            <i (click)="clusterAgent.show = true;$event.stopPropagation()" class="cursor fa fa-caret-down fa-lg"></i>
                                          }
                                          @if (clusterAgent.show) {
                                            <i (click)="clusterAgent.show = false;$event.stopPropagation()" class="cursor fa fa-caret-up fa-lg"></i>
                                          }
                                          <i (click)="navToController(controller.controllerId, clusterAgent.agentId)"
                                             [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'agent.button.manageCluster' | translate"
                                             class="cursor fa fa-list p-l-xs"></i>
                                          @if (permission.joc && permission.joc.administration.controllers.manage) {
                                            <i (click)="addSubagent(clusterAgent, controller)"
                                               [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'agent.button.addSubagent' | translate"
                                               class="cursor fa fa-plus p-l-xs"></i>
                                          }
                                          <a (click)="editAgent(clusterAgent, controller, true)" class="text-dark p-l-xxs">
                                            <span [innerHtml]="clusterAgent.agentId | highlight : agentsFilters.searchText"></span>
                                            @if (clusterAgent.title) {
                                              <i> - </i>
                                            }
                                            <i class="text-muted">{{clusterAgent.title}}</i>
                                          </a>
                                        </span>
                                        </td>
                                        <td (click)="editAgent(clusterAgent, controller, true)"><span
                                          [innerHtml]="clusterAgent.agentName | highlight : agentsFilters.searchText"></span></td>
                                        <td (click)="editAgent(clusterAgent, controller, true)" [nzBreakWord]><span
                                          [innerHtml]="clusterAgent.agentNameAliases || '-'"></span></td>

                                        <td (click)="editAgent(clusterAgent, controller, true)">
                                          @if (clusterAgent.compatibility) {
                                            <i [ngClass]="clusterAgent.compatibility === 'COMPATIBLE' ? 'text-success' : clusterAgent.compatibility === 'NOT_COMPATIBLE' ? 'fa-exclamation-triangle text-danger' : 'fa-exclamation-triangle text-warn'"
                                               [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="clusterAgent.compatibility | translate"
                                               class="fa fa-check"></i>&nbsp;
                                          }
                                          <span [innerHtml]="clusterAgent.version"></span>
                                        </td>
                                        <td>{{clusterAgent.processLimit}}</td>
                                        <td (click)="editAgent(clusterAgent, controller, true)">
                                          @if (clusterAgent.syncState) {
                                            <label [innerHtml]="clusterAgent.syncState._text | translate"
                                                   [ngClass]="coreService.getColor(clusterAgent.syncState.severity, 'bg')"
                                                   class="label"></label>
                                          }
                                        </td>
                                        <td>
                                          @if (!clusterAgent.token) {
                                            <span>-</span>
                                          }
                                          @if (clusterAgent.token) {
                                            <span>{{clusterAgent.token.validUntil | stringToDate}}</span>
                                          }
                                        </td>
                                        <td>
                                          @if (clusterAgent.token) {
                                            <div>
                                              <a [nzPopoverContent]="contentTemplate" class="primary-text-hover-color" nz-popover
                                                 nzPopoverTrigger="click"><i class="fa fa-key"></i></a>
                                              <ng-template #contentTemplate>
                                                <b translate>agent.label.token</b> :
                                                <span>{{clusterAgent.token.UUID}} <i (click)="showCopyMessage()"
                                                                                     [cbContent]="clusterAgent.token.UUID"
                                                                                     class="cursor primary-text-hover-color p-l-sm fa fa-copy"
                                                                                     ngxClipboard></i></span>
                                              </ng-template>
                                            </div>
                                          }
                                          @if (!clusterAgent.token) {
                                            <span>-</span>
                                          }
                                        </td>
                                      </tr>
                                      @if (clusterAgent.show || coreService.preferences.controllers.has(clusterAgent.agentId)) {
                                        <tr>
                                          <td colspan="11" style="padding: 0 !important;border-top: none!important;">
                                            <nz-table class="m-a-0 inner-table" #subagentClusterTable nzSize="small"
                                                      [nzBordered]="true"
                                                      [nzData]="clusterAgent.subagents | orderBy: 'ordering'"
                                                      [nzShowPagination]="false" [nzFrontPagination]="false">

                                              <thead>
                                              <tr class="order-history-template0">
                                                @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                  <th [(nzChecked)]="clusterAgent.checked"
                                                      [nzDisabled]="object.mapOfCheckedId.size > 0 || object.mapOfCheckedId2.size > 0"
                                                      [nzIndeterminate]="clusterAgent.indeterminate"
                                                      [nzShowCheckbox]="true"
                                                      (nzCheckedChange)="checkAllSubagent($event, clusterAgent)"
                                                      class="chk"
                                                  ></th>
                                                }
                                                <th nzWidth="56px"><span translate>common.label.action</span></th>
                                                <th><span translate>agent.label.subagentId</span></th>
                                                <th><span translate>agent.label.role</span></th>
                                                <th><span translate>agent.label.url</span></th>
                                                <th><span translate>dashboard.label.version</span></th>
                                                <th nzWidth="150px"><span translate>common.label.status</span></th>
                                                <th nzWidth="140px"><span translate>agent.label.disabled</span></th>
                                                <th nzWidth="100px"><span class="p-r-xs" translate>encipherment.label.certificates</span></th>
                                              </tr>
                                              </thead>
                                              <tbody (cdkDropListDropped)="drop($event, clusterAgent)" cdkDropList>
                                                @for (sub of subagentClusterTable.data; track sub.subagentId) {
                                                  <tr [ngClass]="{'disabled-row': sub.disabled}" cdkDrag
                                                      class="order-history-template0 move-on-hover cursor">
                                                    @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                      <td class="chk"
                                                          [nzChecked]="object.mapOfCheckedId3.has(sub.subagentId)" [nzDisabled]="object.mapOfCheckedId.size > 0 || object.mapOfCheckedId2.size > 0"
                                                          [nzShowCheckbox]="true" (nzCheckedChange)="onItemCheckedSubagent(clusterAgent, sub, $event)">
                                                        <div cdkDragHandle class="pos-abt move-icon text-16 cur-m t-1" style="left: -1px;">
                                                          <i aria-hidden="true" class="fa fa-bars"></i>
                                                        </div>
                                                      </td>
                                                    }
                                                    @if (permission.joc && permission.joc.administration.controllers.manage) {
                                                      <td class="menu">
                                                        <div class="btn-group dropdown pull-left m-r-sm">
                                                          <button (nzVisibleChange)="onVisible($event)" [nzDisabled]="clusterAgent.checked || clusterAgent.indeterminate" [nzDropdownMenu]="option" class="btn-drop more-option-h"
                                                                  nz-dropdown
                                                                  nzTrigger="click" type="button"><i
                                                            class="fa fa-ellipsis-h"></i></button>
                                                          <nz-dropdown-menu #option="nzDropdownMenu" role="menu">
                                                            <ul nz-menu>
                                                              <li (click)="editSubagent(sub, clusterAgent, controller)" nz-menu-item>
                                                                <a translate>common.button.edit</a>
                                                              </li>
                                                              <li (click)="addCertificateToSubAgent(sub, clusterAgent, controller)" nz-menu-item>
                                                                <a translate>agent.button.addEnciphermentCertificate</a>
                                                              </li>
                                                              @if (sub.isDirector == 'NO_DIRECTOR') {
                                                                <li nz-menu-divider></li>
                                                              }
                                                              @if (!sub.disabled) {
                                                                <li (click)="disableEnableSubagent(sub, controller, false)" nz-menu-item>
                                                                  <a translate>agent.button.disable</a>
                                                                </li>
                                                              }
                                                              @if (sub.disabled) {
                                                                <li (click)="disableEnableSubagent(sub, controller, true)" nz-menu-item>
                                                                  <a translate>agent.button.enable</a>
                                                                </li>
                                                              }
                                                              @if (sub.isDirector == 'NO_DIRECTOR') {
                                                                <li (click)="resetSubagent(sub, clusterAgent, controller)" nz-menu-item>
                                                                  <a translate>agent.button.reset</a>
                                                                </li>
                                                              }
                                                              @if (sub.isDirector == 'NO_DIRECTOR') {
                                                                <li (click)="resetSubagent(sub, clusterAgent, controller, true)" nz-menu-item>
                                                                  <a translate>agent.button.resetForced</a>
                                                                </li>
                                                              }
                                                              <li nz-menu-divider></li>
                                                              <li (click)="removeSubagent(sub, clusterAgent, controller)" class="bg-hover-color"
                                                                  nz-menu-item>
                                                                <a translate="">common.button.delete</a>
                                                              </li>
                                                            </ul>
                                                          </nz-dropdown-menu>
                                                        </div>
                                                      </td>
                                                    }
                                                    <td (click)="editSubagent(sub, clusterAgent, controller)">
                                                      {{sub.subagentId}}
                                                      @if (sub.title) {
                                                        <i> - </i>
                                                      }
                                                      <i class="text-muted">{{sub.title}}</i>
                                                    </td>
                                                    <td (click)="editSubagent(sub, clusterAgent, controller)">{{sub.isDirector | translate}}</td>
                                                    <td (click)="editSubagent(sub, clusterAgent, controller)">{{sub.url}}</td>
                                                    <td (click)="editSubagent(sub, clusterAgent, controller)">
                                                      @if (sub.compatibility) {
                                                        <i [ngClass]="sub.compatibility === 'COMPATIBLE' ? 'text-success' : sub.compatibility === 'NOT_COMPATIBLE' ? 'fa-exclamation-triangle text-danger' : 'fa-exclamation-triangle text-warn'"
                                                           [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="sub.compatibility | translate"
                                                           class="fa fa-check"></i>&nbsp;
                                                      }
                                                      <span [innerHtml]="sub.version"></span>
                                                    </td>
                                                    <td (click)="editSubagent(sub, clusterAgent, controller)">
                                                      @if (sub.syncState) {
                                                        <label [innerHtml]="sub.syncState._text | translate"
                                                               [ngClass]="coreService.getColor(sub.syncState.severity, 'bg')"
                                                               class="label"></label>
                                                      }
                                                    </td>
                                                    <td
                                                      (click)="editSubagent(sub, clusterAgent, controller)">{{(sub.disabled ? 'common.label.yes' : 'common.label.no') | translate}}</td>
                                                    <td (click)="showCertificateAliases(clusterAgent,sub, 'cluster')">
                                                      <a><i class="fa fa-list-alt"></i></a>
                                                    </td>
                                                  </tr>
                                                }
                                              </tbody>
                                            </nz-table>
                                          </td>
                                        </tr>
                                      }
                                    </ng-container>
                                  }
                                </tbody>
                              </nz-table>
                            }
                          </div>
                        </div>
                      </div>
                    }
                    @if (coreService.preferences.controllers.has(controller.controllerId)) {
                      <hr>
                    }
                  </ng-container>
                }
              </div>
            }
            @if (controllers.length==0 && loading) {
              <div>
                <app-empty-data></app-empty-data>
              </div>
            }
            @if (!loading) {
              <div class="m-a-lg text-center">
                <nz-spin nzSimple></nz-spin>
              </div>
            }
            @if (controllers.length>0) {
              <div class="rg-bottom"><span></span></div>
            }
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
