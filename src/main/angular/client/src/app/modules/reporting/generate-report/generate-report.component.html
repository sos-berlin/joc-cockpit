
<div>
  <div class="box p-a">
    <div class="table-responsive">
      <nz-table
        #ajaxTable
        [nzBordered]="true"
        [nzData]="filteredData"
        [nzLoading]="!isLoaded"
        [nzPageIndex]="filters.filter.currentPage"
        [nzPageSizeOptions]="[10, 25, 50, 100, +(preferences.maxEntryPerPage)]"
        [nzPageSize]="filters.filter.entryPerPage || preferences.entryPerPage || 25"
        [nzShowPagination]="filteredData.length > 0"
        [nzShowSizeChanger]="true"
        [nzSize]="'small'"
      >
        <thead>
        <tr>
          <th *ngIf="permission.joc && permission.joc.reports.manage" [(nzChecked)]="object.checked"
              [nzIndeterminate]="object.indeterminate"
              [nzShowCheckbox]="true"
              (nzCheckedChange)="checkAll($event)"
              class="chk"
          ></th>
          <th class="menu"><span
            translate>common.label.action</span></th>
          <th *ngIf="filters.groupBy == 'path'" (click)="sort('path')"><a><span class="p-r-xs">
            {{'common.label.name' | translate}} / {{'reporting.label.template' | translate}}</span>
            <i *ngIf="filters.filter.sortBy == 'path' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'path' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
          <th *ngIf="filters.groupBy == 'template'" (click)="sort('template')"><a><span class="p-r-xs"
          >
            {{'reporting.label.template' | translate}} / {{'common.label.name' | translate}}
          </span>
            <i *ngIf="filters.filter.sortBy == 'template' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'template' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
          <th (click)="sort('controllerId')" ><a><span class="p-r-xs" translate>common.label.controllerId</span>
            <i *ngIf="filters.filter.sortBy == 'controllerId' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'controllerId' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
          <th (click)="sort('frequency')" nzWidth="150px"><a><span class="p-r-xs"
                                                   translate>reporting.label.frequency</span>
            <i *ngIf="filters.filter.sortBy == 'frequency' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'frequency' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
          <th (click)="sort('dateFrom')" nzWidth="110px"><a><span class="p-r-xs" translate>reporting.label.dateFrom</span>
            <i *ngIf="filters.filter.sortBy == 'dateFrom' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'dateFrom' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
          <th (click)="sort('dateTo')" nzWidth="110px"><a><span class="p-r-xs" translate>reporting.label.dateTo</span>
            <i *ngIf="filters.filter.sortBy == 'dateTo' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'dateTo' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
          <th (click)="sort('created')" nzWidth="150px"><a><span class="p-r-xs" translate>reporting.label.created</span>
            <i *ngIf="filters.filter.sortBy == 'created' && !filters.filter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="filters.filter.sortBy == 'created' && filters.filter.reverse"
               class="fa fa-caret-down "></i></a>
          </th>
        </tr>
        </thead>
        <ng-container>
        <tbody>
        <ng-template [ngForOf]="ajaxTable.data" let-item
                     ngFor>
          <tr class="cursor" >
            <td *ngIf="permission.joc && permission.joc.reports.manage" [nzIndeterminate]="item.indeterminate"
                [nzChecked]="item.checked"
                (nzCheckedChange)="checkAllChild(item, $event)"
                [nzShowCheckbox]="true">
            </td>
            <td >
              <div class="btn-group dropdown">
                <button [nzDropdownMenu]="option" class="btn-drop more-option-h"
                        nz-dropdown nzTrigger="click" type="button">
                  <i class="fa fa-ellipsis-h"></i>
                </button>
                <nz-dropdown-menu #option="nzDropdownMenu" role="menu">
                  <ul nz-menu>
                    <li nz-menu-item (click)="onSelect(item)">
                      <a translate>reporting.button.showReport</a>
                    </li>
                    <li *ngIf="permission.joc && permission.joc.reports.manage" nz-menu-item (click)="deleteReport(item)">
                      <a translate>common.button.delete</a>
                    </li>
                  </ul>
                </nz-dropdown-menu>
              </div>
            </td>
            <td colspan="6">
              <span class="w-full" *ngIf="filters.groupBy !== 'template'">
                <i class="fa fa-angle-right cursor fa-lg p-r-sm" aria-hidden="true" *ngIf="!item.expanded" (click)="toggleRowExpansion(item)"></i>
                <i class="fa fa-angle-down cursor fa-lg p-r-sm" aria-hidden="true" *ngIf="item.expanded" (click)="toggleRowExpansion(item)"></i>
                <i (click)="coreService.navToInventoryTab(item.path, 'REPORT');"
                   *ngIf="permission.joc && permission.joc.inventory.view"
                   class="cursor fa fa-pencil text-hover-primary p-r-xs"></i>
                <span (click)="onSelect(item)" [innerHtml]="item.path | highlight : filters.searchText"></span>
                <i *ngIf="item.title"> - </i>
                <i [innerHtml]="item.title" class="text-muted"></i>
              </span>
              <span class="w-full" *ngIf="filters.groupBy == 'template'">
                <i class="fa fa-angle-right  cursor fa-lg p-r-sm" aria-hidden="true" *ngIf="!item.expanded" (click)="toggleRowExpansion(item)"></i>
                <i class="fa fa-angle-down cursor fa-lg p-r-sm" aria-hidden="true" *ngIf="item.expanded" (click)="toggleRowExpansion(item)"></i>
                <span (click)="onSelect(item)" [innerHtml]="item.template | highlight : filters.searchText"></span>
              </span>
            </td>
          </tr>
          <ng-container *ngIf="item.expanded">
            <tr *ngFor="let child of item.value" class="cursor">
              <td *ngIf="permission.joc && permission.joc.reports.manage" [nzChecked]="object.mapOfCheckedId.has(child.id)" (nzCheckedChange)="onItemChecked(item, child, $event)"
                  [nzShowCheckbox]="true"></td>
              <td >
                <div class="btn-group dropdown">
                  <button [nzDropdownMenu]="option" class="btn-drop more-option-h"
                          nz-dropdown nzTrigger="click" type="button">
                    <i class="fa fa-ellipsis-h"></i>
                  </button>
                  <nz-dropdown-menu #option="nzDropdownMenu" role="menu">
                    <ul nz-menu>
                      <li nz-menu-item (click)="onSelect(child)">
                        <a translate>reporting.button.showReport</a>
                      </li>
                      <li *ngIf="permission.joc && permission.joc.reports.manage" nz-menu-item (click)="deleteReport(child)">
                        <a translate>common.button.delete</a>
                      </li>
                    </ul>
                  </nz-dropdown-menu>
                </div>
              </td>
              <td *ngIf="filters.groupBy == 'template'" >
                <span class="w-full p-l-12">
                  <i (click)="coreService.navToInventoryTab(child.path, 'REPORT');"
                     *ngIf="permission.joc && permission.joc.inventory.view"
                     class="cursor fa fa-pencil text-hover-primary p-r-xs"></i>
                  <span (click)="onSelect(child)" [innerHtml]="child.path | highlight : filters.searchText"></span>
                  <i *ngIf="child.title"> - </i>
                  <i [innerHtml]="child.title" class="text-muted"></i>
                </span>
              </td>
              <td (click)="onSelect(child)" *ngIf="filters.groupBy !== 'template'" >
                <span class="p-l-12" [innerHtml]="child.template | highlight : filters.searchText"></span>
              </td>
              <td (click)="onSelect(child)"><span [innerHtml]="child.controllerId | highlight : filters.searchText"></span></td>
              <td (click)="onSelect(child)"><span
                [innerHtml]="child.frequency | translate | highlight : filters.searchText"></span></td>
              <td (click)="onSelect(child)"><span
                [innerHtml]="child.dateFrom | highlight : filters.searchText"></span></td>
              <td (click)="onSelect(child)"><span
                [innerHtml]="child.dateTo | highlight : filters.searchText"></span></td>
              <td (click)="onSelect(child)"><span [innerHtml]="child.created | stringToDate | highlight : filters.searchText"></span></td>
            </tr>
          </ng-container>
        </ng-template>
        </tbody>
        </ng-container>
      </nz-table>
    </div>
    <div *ngIf="ajaxTable.data.length >0"
         class="w-half label-top"><span
      translate>common.label.total</span> {{filteredData.length}}
      <span *ngIf="ajaxTable.data.length >1" translate>inventory.label.entriesFound</span>
      <span *ngIf="ajaxTable.data.length ==1" translate>inventory.label.entryFound</span>
    </div>
  </div>
</div>

<nz-drawer (nzOnClose)="closePanel()" [nzWrapClassName]="'report-drawer'" [nzVisible]="isVisible" nzPlacement="right">
  <ng-container *nzDrawerContent>
      <app-frequency-report *ngIf="isVisible" (closePanel)="closePanel()" [templates]="templates" [groupBy]="filters.groupBy"
                            [selectedReport]="selectedReport"></app-frequency-report>
  </ng-container>
</nz-drawer>
