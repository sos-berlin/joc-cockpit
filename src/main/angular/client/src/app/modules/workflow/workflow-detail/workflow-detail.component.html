<div class="white box-shadow sub-header" style="height: 54px">
  <div class="row">
    <div class="col-md-12">
      <div class="padding">
        <div class="text-right ">
          <div class="pull-left">
            <span class="text-md text-muted _600 ">
              <ol class="breadcrumb p-t-xs">
                <li>
                  <a (click)="backClicked()">
                    <i title="back" class="fa fa-arrow-circle-left"
                       style="font-size: 18px"></i></a>
                </li>
                <li>
                  <span>
                    <a routerLink="/workflows"> {{ 'breadcrumb.label.workflows' | translate }}</a>
                  </span>
                </li>
                <li>
                  <span class="text-muted">
                    {{workFlowJson.name}}
                  </span>
                </li>
              </ol>
            </span>
          </div>
          <div class="inline m-r">
            <ul class="nav navbar-nav navbar-nav-inline nav-active-border3 " style="margin-top: -6px">
              <li class="nav-item" [hidden]="pageView === 'list'">
                <a class="nav-link" [nz-tooltip]="'workflow.button.zoomIn' | translate"
                   (click)="zoomIn()">
                  <span class="nav-text"> <i nz-icon nzType="zoom-in" nzTheme="outline"></i></span>
                </a>
              </li>
              <li class="nav-item" [hidden]="pageView === 'list'">
                <a class="nav-link"
                   [nz-tooltip]="'workflow.button.zoomOut' | translate" (click)="zoomOut()">
                  <span class="nav-text"> <i nz-icon nzType="zoom-out" nzTheme="outline"></i></span>
                </a>
              </li>
              <li class="nav-item dropdown-separator" [hidden]="pageView === 'list'">
                <span class="separator"></span>
              </li>
              <li class="nav-item" [hidden]="pageView === 'list'">
                <a class="nav-link" [nz-tooltip]="'workflow.button.actual' | translate"
                   (click)="actual()">
                  <span class="nav-text"> <i nz-icon nzType="fullscreen-exit" nzTheme="outline"></i></span>
                </a>
              </li>
              <li class="nav-item" [hidden]="pageView === 'list'">
                <a class="nav-link" [nz-tooltip]="'workflow.button.fit' | translate"
                   (click)="fit()">
                  <span class="nav-text"> <i nz-icon nzType="column-width" nzTheme="outline"></i></span>
                </a>
              </li>
              <li class="nav-item dropdown-separator">
                <span class="separator"></span>
              </li>
              <li class="nav-item">
                <a class="nav-link"
                   [nz-tooltip]="'common.button.expandAll' | translate" (click)="expandAll()">
                  <span class="nav-text"> <i nz-icon nzType="plus" nzTheme="outline"></i></span>
                </a>
              </li>
              <li class="nav-item">
                <a class="nav-link"
                   [nz-tooltip]="'common.button.collapseAll' | translate" (click)="collapseAll()">
                  <span class="nav-text"> <i nz-icon nzType="minus" nzTheme="outline"></i></span>
                </a>
              </li>
              <li class="nav-item dropdown-separator">
                <span class="separator"></span>
              </li>
            </ul>
          </div>
          <div class="inline" style="position: relative;top:-21px">
            <button class="btn btn-grey btn-sm m-l-12 button-group-ellipsis" (click)="addOrder()" *ngIf="permission.Workflow.execute.addOrder"><i class="fa fa-plus-square"></i>
              &nbsp;<span class="hidden-sm-down" translate>workflow.button.addOrder</span>
            </button>
            <button class="btn btn-grey btn-sm m-l-12 button-group-ellipsis" (click)="showDailyPlan()" *ngIf="permission.Workflow.execute.addOrder"><i class="fa fa-calendar"></i>
              &nbsp;<span class="hidden-sm-down" translate>workflow.button.showDailyPlan</span>
            </button>
            <app-toggle (messageEvent)="receiveMessage($event)"></app-toggle>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="scroll-y max-ht">
  <div class="padding p-b-0">
    <div class="row m-t-sm">
      <div class="col-lg-12">
        <div class="hide" [ngClass]="{'show': loading}">
          <div [hidden]="pageView !== 'grid' || !workFlowJson.instructions">
            <div id="toolbar"></div>
            <div appResizable class="resizable" [height]="worflowFilters.panelSize" [workflowTab]="worflowFilters" id="workflowGraphId">
              <div class="overflow-y" style="height: 100%">
                <div class="graph-container ">
                  <div id="graph"></div>
                  <!-- Creates a container for the outline -->
                  <div id="outlineContainer"></div>
                </div>
                <div class="rg-bottom"><span></span></div>
              </div>
            </div>
          </div>
          <div *ngIf="pageView !== 'grid' && workFlowJson.instructions">
            <div class="box m-b-0 p-a-0 resizable" appResizable [height]="worflowFilters.panelSize2" [workflowTab]="worflowFilters" id="workflowTextId">
              <div class="p-a overflow-y" style="height: 100%">
                <div class="text-primary" translate>workflow.label.start</div>
                <app-type [configuration]="workFlowJson" [expandAll]="isExpandAll"></app-type>
                <div class="text-primary" translate>workflow.label.end</div>
                <div class="rg-bottom"><span></span></div>
              </div>
            </div>
          </div>
          <div *ngIf="!workFlowJson.instructions" class="text text-center text-uppercase p-a-md">
            <app-empty-data></app-empty-data>
          </div>
          <div class="scrolltop-btn">
            <a (click)="scrollTop()">
              <i class="fa fa-angle-up"></i>
            </a>
          </div>
          <div class="scrollBottom-btn">
            <a (click)="scrollBottom()" data-toggle="tooltip" title="{{'history.button.showHistory' | translate}}">
              <i class="fa fa-angle-down"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
    <div class="row m-t">
      <div class="col-md-12" *ngIf="loading && workFlowJson && workFlowJson.name">
        <div class="box white">
          <div class="box-header">
            <span class="text">{{workFlowJson.path}}: {{workFlowJson.name}} <i *ngIf="workFlowJson.title">-</i> <i
                      class="text-sm text-muted">{{workFlowJson.title}}</i></span>
          </div>
          <div class="box-body p-t-0 b-t">
            <nz-tabset>
              <nz-tab [nzTitle]="'history.label.orderHistory' | translate" (nzClick)="loadOrderHistory()">
                <nz-table
                  #orderHistoryTable
                  [nzSize]="'small'"
                  [nzBordered]="true"
                  [nzShowPagination]="false"
                  [nzData]="orderHistory"
                >
                  <thead>
                  <tr>
                    <th><span translate>history.label.orderId</span></th>
                    <th><span translate>history.label.position</span></th>
                    <th><span translate>history.label.status</span></th>
                    <th><span translate>history.label.plannedTime</span></th>
                    <th><span translate>history.label.startTime</span></th>
                    <th><span translate>history.label.endTime</span></th>
                    <th><span translate>history.label.duration</span></th>
                  </tr>
                  </thead>
                  <tbody>
                  <ng-template ngFor let-history [ngForOf]="orderHistoryTable.data | orderBy: 'plannedTime':true">
                    <tr (click)="coreService.showLogWindow(history,null, null, history.controllerId, null)" class="cursor">
                      <td [innerHtml]="history.orderId"></td>
                      <td [innerHtml]="history.position"></td>
                      <td>
                                <span class="label" [ngClass]="coreService.getColor(history.state.severity,'bg')"
                                      [innerHtml]="history.state._text | translate"></span>
                      </td>
                      <td [innerHtml]="history.plannedTime | stringToDate"></td>
                      <td [innerHtml]="history.startTime | stringToDate"></td>
                      <td [innerHtml]="history.endTime | stringToDate"></td>
                      <td [innerHtml]="history.startTime | duration:history.endTime"></td>
                    </tr>
                  </ng-template>
                  </tbody>
                </nz-table>
              </nz-tab>
              <nz-tab [nzTitle]="'history.label.taskHistory' | translate" (nzClick)="loadTaskHistory()">
                <nz-table
                  #taskHistoryTable
                  [nzSize]="'small'"
                  [nzBordered]="true"
                  [nzShowPagination]="false"
                  [nzData]="taskHistory"
                >
                  <thead>
                  <tr>
                    <th><span translate>history.label.job</span></th>
                    <th><span translate>history.label.position</span></th>
                    <th><span translate>history.label.status</span></th>
                    <th><span translate>history.label.startTime</span></th>
                    <th><span translate>history.label.endTime</span></th>
                    <th><span translate>history.label.duration</span></th>
                    <th><span translate>history.label.criticality</span></th>
                    <th><span translate>history.label.returnCode</span></th>
                  </tr>
                  </thead>
                  <tbody>
                  <ng-template ngFor let-history [ngForOf]="taskHistoryTable.data | orderBy: 'startTime':true">
                    <tr (click)="coreService.showLogWindow(null, history, null, null, null)" class="cursor">
                      <td [innerHtml]="history.job"></td>
                      <td [innerHtml]="history.position"></td>
                      <td>
                                <span class="label" [ngClass]="coreService.getColor(history.state.severity,'bg')"
                                      [innerHtml]="history.state._text | translate"></span>
                      </td>
                      <td [innerHtml]="history.startTime | stringToDate"></td>
                      <td [innerHtml]="history.endTime | stringToDate"></td>
                      <td [innerHtml]="history.startTime | duration:history.endTime"></td>
                      <td [innerHtml]="history.criticality | translate"></td>
                      <td [innerHtml]="history.exitCode"></td>
                    </tr>
                  </ng-template>
                  </tbody>
                </nz-table>
              </nz-tab>
              <nz-tab [nzTitle]="'auditLog.label.auditLog' | translate" (nzClick)="loadAuditLogs()">
                <nz-table
                  #auditTable
                  [nzSize]="'small'"
                  [nzBordered]="true"
                  [nzShowPagination]="false"
                  [nzData]="auditLogs"
                >
                  <thead>
                  <tr>
                    <th><span translate>auditLog.label.created</span></th>
                    <th><span translate>auditLog.label.account</span></th>
                    <th><span translate>auditLog.label.request</span></th>
                    <th><span translate>auditLog.label.orderId</span></th>
                    <th><span translate>auditLog.label.comment</span></th>
                    <th><span translate>auditLog.label.timeSpend</span></th>
                    <th><span translate>auditLog.label.ticketLink</span></th>
                  </tr>
                  </thead>
                  <tbody>
                  <ng-template ngFor let-auditLog [ngForOf]="auditTable.data | orderBy: 'created':true">
                    <tr>
                      <td>
                        <i class="cursor fa fa-caret-down fa-lg tableexport-ignore" *ngIf="!auditLog.show"
                           (click)="auditLog.show =true"></i>
                        <i class="cursor fa fa-caret-up fa-lg tableexport-ignore"
                           *ngIf="auditLog.show" (click)="auditLog.show =false"></i>
                        &nbsp;
                        <span [innerHtml]="auditLog.created | stringToDate"></span>
                      </td>
                      <td><span [innerHtml]="auditLog.account"></span></td>
                      <td><span [innerHtml]="auditLog.request"></span></td>
                      <td><span [innerHtml]="auditLog.orderId"></span></td>
                      <td><span [innerHtml]="auditLog.comment"></span></td>
                      <td>
                                    <span *ngIf="auditLog.timeSpent">
                                      <span [innerHtml]="auditLog.timeSpent"></span><span>m</span>
                                    </span>
                      </td>
                      <td>
                        <a href="{{auditLog.ticketLink}}" class="text-hover-primary" target="_blank" [innerHtml]="auditLog.ticketLink"></a>
                      </td>
                    </tr>
                    <tr class="tableexport-ignore" *ngIf="auditLog.show">
                      <td colspan="7">
                        <div class="m-a-0">
                          <span translate>auditLog.label.parameters</span>
                          :
                          <span [innerHtml]="auditLog.parameters"></span>
                        </div>
                      </td>
                    </tr>
                  </ng-template>
                  </tbody>
                </nz-table>
              </nz-tab>
            </nz-tabset>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="spinner" *ngIf="!loading">
  <div class="cssload-inner cssload-one"></div>
  <div class="cssload-inner cssload-two"></div>
  <div class="cssload-inner cssload-three"></div>
</div>
