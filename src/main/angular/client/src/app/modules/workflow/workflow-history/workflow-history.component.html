<nz-tabset [(nzSelectedIndex)]="index">
  <nz-tab *ngIf="permission.currentController && permission.currentController.orders.view"
          [nzTitle]="'history.label.orderHistory' | translate" (nzClick)="loadOrderHistory()">
    <a class="text-primary text-hover-primary pos-abt r-15" (click)="navToHistory('ORDER')" style="top: 64px" translate>common.button.viewHistory</a>
    <div class="table-responsive" id="orderTable">
      <nz-table
        #orderHistoryTable
        [nzLoading]="loading"
        [nzSize]="'small'"
        [nzBordered]="true"
        [nzShowPagination]="false"
        [nzFrontPagination]="false"
        [nzData]="orderHistory | orderBy: workflowFilters.historyFilter.sortBy: workflowFilters.historyFilter.reverse"
      >
        <thead>
        <tr>
          <th class="dynamic-thead" (click)="sort('orderId','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.orderId</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'orderId' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'orderId' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('position','orderHistory')"><a><span
            class="p-r-xs" translate>history.label.position</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'position' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'position' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('status','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.status</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'status' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'status' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('orderState','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.orderState</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'orderState' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'orderState' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('plannedTime','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.plannedTime</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'plannedTime' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'plannedTime' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('startTime','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.startTime</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'startTime' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'startTime' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('endTime','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.endTime</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'endTime' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'endTime' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
          <th class="dynamic-thead" (click)="sort('duration','orderHistory')"><a>
            <span class="p-r-xs" translate>history.label.duration</span>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'duration' && !workflowFilters.historyFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.historyFilter.sortBy == 'duration' && workflowFilters.historyFilter.reverse"
               class="fa fa-caret-down "></i></a></th>
        </tr>
        </thead>
        <tbody>
        <ng-template ngFor let-history [ngForOf]="orderHistoryTable.data">
          <tr (click)="coreService.showLogWindow(history,null, null, history.controllerId, null)"
              class="cursor" [ngClass]="{'light-bg':history.show}">
            <td>
            <span class="show-in-single-line w-full">
               <i class="cursor fa fa-chevron-down p-l-xs p-r-xs" [nz-tooltip]="'history.button.expandAll' | translate"
                  *ngIf="!history.showAll" (click)="showAllPanelFuc(history);$event.stopPropagation()"></i>
              <i class="cursor fa fa-chevron-up p-l-xs p-r-xs" [nz-tooltip]="'history.button.collapseAll' | translate"
                 *ngIf="history.showAll" (click)="hideAllPanelFuc(history);$event.stopPropagation()"></i>
              <i class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs"
                 *ngIf="!history.show"
                 (click)="showPanelFuc(history);$event.stopPropagation()"></i>
              <i class="cursor fa fa-caret-up fa-lg p-l-xs p-r-xs"
                 *ngIf="history.show"
                 (click)="hidePanelFuc(history);$event.stopPropagation()"></i>
              <i class="cursor fa fa-download text-hover-primary p-l-xs p-r-xs"
                 (click)="downloadLog(history);$event.stopPropagation()"></i>
              <span [innerHtml]="history.orderId"></span>
            </span>
            </td>
            <td [innerHtml]="history.position"></td>
            <td>
            <span class="label" [ngClass]="coreService.getColor(history.state.severity,'bg')"
                  [innerHtml]="history.state._text | translate"></span>
            </td>
            <td>
            <span *ngIf="history.orderState" class="label"
                  [ngClass]="coreService.getColor(history.orderState.severity,'bg')"
                  [innerHtml]="history.orderState._text | translate"></span>
            </td>
            <td [innerHtml]="history.plannedTime | stringToDate"></td>
            <td [innerHtml]="history.startTime | stringToDate"></td>
            <td [innerHtml]="history.endTime | stringToDate"></td>
            <td [innerHtml]="history.startTime | duration:history.endTime"></td>
          </tr>
          <ng-container *ngIf="history.show">
            <tr *ngIf="history.arguments">
              <td colspan="8">
                <app-order-variable [order]="history" [type]="'arguments'" [history]="true"
                                    [schedulerId]="schedulerIds.selected"></app-order-variable>
              </td>
            </tr>
            <tr>
              <td colspan="8" style="padding:0 !important;">
                <app-order-history-template [permission]="permission" class="order-history-template0"
                                            style="display: block" [history]="history"
                                            [schedulerId]="schedulerIds.selected"></app-order-history-template>
              </td>
            </tr>
          </ng-container>
        </ng-template>
        </tbody>
      </nz-table>
    </div>
  </nz-tab>
  <nz-tab *ngIf="permission.currentController && permission.currentController.orders.view"
          [nzTitle]="'history.label.taskHistory' | translate" (nzClick)="loadTaskHistory()">
    <a class="text-primary text-hover-primary pos-abt r-15" (click)="navToHistory('TASK')" style="top: 64px" translate>common.button.viewHistory</a>
    <div class="table-responsive">
      <nz-table
        #taskHistoryTable
        [nzSize]="'small'"
        [nzBordered]="true"
        [nzFrontPagination]="false"
        [nzShowPagination]="false"
        [nzData]="taskHistory | orderBy: workflowFilters.taskHistoryFilter.sortBy: workflowFilters.taskHistoryFilter.reverse"
      >
        <thead>
        <tr>
          <th (click)="sort('job','taskHistory')"><span class="p-r-xs" translate>history.label.job</span>
            <i *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'job' && !workflowFilters.taskHistoryFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'job' && workflowFilters.taskHistoryFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('position','taskHistory')"><span class="p-r-xs" translate>history.label.position</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'position' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'position' && workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-down "></i></th>
          <th (click)="sort('status','taskHistory')"><span class="p-r-xs" translate>history.label.status</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'status' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'status' && workflowFilters.taskHistoryFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('startTime','taskHistory')"><span class="p-r-xs" translate>history.label.startTime</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'startTime' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'startTime' && workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-down "></i></th>
          <th (click)="sort('endTime','taskHistory')"><span class="p-r-xs" translate>history.label.endTime</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'endTime' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'endTime' && workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-down "></i></th>
          <th (click)="sort('duration','taskHistory')"><span class="p-r-xs" translate>history.label.duration</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'duration' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'duration' && workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-down "></i></th>
          <th (click)="sort('criticality','taskHistory')"><span class="p-r-xs" translate>history.label.criticality</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'criticality' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'criticality' && workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-down "></i></th>
          <th (click)="sort('returnCode','taskHistory')"><span class="p-r-xs" translate>history.label.returnCode</span>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'returnCode' && !workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-up "></i>
            <i
              *ngIf="workflowFilters.taskHistoryFilter.sortBy == 'returnCode' && workflowFilters.taskHistoryFilter.reverse"
              class="fa fa-caret-down "></i></th>
        </tr>
        </thead>
        <tbody>
        <ng-template ngFor let-history [ngForOf]="taskHistoryTable.data">
          <tr (click)="coreService.showLogWindow(null, history, null, history.controllerId, null)" class="cursor"
              [ngClass]="{'light-bg':history.show}">
            <td>
               <span class="show-in-single-line">
                  <i class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs"
                     [ngClass]="history.show ? 'fa-caret-up' : 'fa-caret-down'"
                     (click)="history.show=!history.show;$event.stopPropagation()"></i>
                  <span [innerHtml]="history.job"></span>
                </span>
            </td>
            <td [innerHtml]="history.position"></td>
            <td>
            <span class="label" [ngClass]="coreService.getColor(history.state.severity,'bg')"
                  [innerHtml]="history.state._text | translate"></span>
            </td>
            <td [innerHtml]="history.startTime | stringToDate"></td>
            <td [innerHtml]="history.endTime | stringToDate"></td>
            <td [innerHtml]="history.startTime | duration:history.endTime"></td>
            <td [innerHtml]="history.criticality | translate"></td>
            <td [innerHtml]="history.exitCode"></td>
          </tr>
          <tr *ngIf="history.show">
            <td colspan="8">
              <app-order-variable [order]="history" [type]="'arguments'" [history]="true"
                                  [schedulerId]="schedulerIds.selected"></app-order-variable>
            </td>
          </tr>
        </ng-template>
        </tbody>
      </nz-table>
    </div>
  </nz-tab>
  <nz-tab *ngIf="jobName && permission.currentController && permission.currentController.orders.view"
          [nzTitle]="titleTemplate" (nzClick)="loadJobHistory()">
    <ng-template #titleTemplate>
      <span translate>history.label.jobHistory</span>
      <span class="text-muted p-l-xs">({{jobName}})</span>
    </ng-template>
    <div class="table-responsive">
      <nz-table
        #jobHistoryTable
        [nzSize]="'small'"
        [nzBordered]="true"
        [nzFrontPagination]="false"
        [nzShowPagination]="false"
        [nzData]="jobHistory"
      >
        <thead>
        <tr>
          <th><span translate>history.label.position</span></th>
          <th><span translate>history.label.status</span></th>
          <th><span translate>history.label.startTime</span></th>
          <th><span translate>history.label.endTime</span></th>
          <th><span translate>history.label.duration</span></th>
          <th><span translate>history.label.criticality</span></th>
          <th><span translate>history.label.returnCode</span></th>
        </tr>
        </thead>
        <tbody>
        <ng-template ngFor let-history [ngForOf]="jobHistoryTable.data | orderBy: 'startTime':true">
          <tr (click)="coreService.showLogWindow(null, history, null, history.controllerId, null)" class="cursor">
            <td [innerHtml]="history.position"></td>
            <td>
            <span class="label" [ngClass]="coreService.getColor(history.state.severity,'bg')"
                  [innerHtml]="history.state._text | translate"></span>
            </td>
            <td [innerHtml]="history.startTime | stringToDate"></td>
            <td [innerHtml]="history.endTime | stringToDate"></td>
            <td [innerHtml]="history.startTime | duration:history.endTime"></td>
            <td [innerHtml]="history.criticality | translate"></td>
            <td [innerHtml]="history.exitCode"></td>
          </tr>
          <tr *ngIf="history.show">
            <td colspan="8">
              <app-order-variable [order]="history" [type]="'arguments'" [history]="true"
                                  [schedulerId]="schedulerIds.selected"></app-order-variable>
            </td>
          </tr>
        </ng-template>
        </tbody>
      </nz-table>
    </div>
  </nz-tab>
  <nz-tab *ngIf="(permission.joc && permission.joc.auditLog.view)" [nzTitle]="'auditLog.label.auditLog' | translate"
          (nzClick)="loadAuditLogs()">
    <div class="table-responsive ">
      <nz-table
        #auditTable
        [nzSize]="'small'"
        [nzBordered]="true"
        [nzFrontPagination]="false"
        [nzShowPagination]="false"
        [nzData]="auditLogs| orderBy: workflowFilters.auditLogFilter.sortBy: workflowFilters.auditLogFilter.reverse"
      >
        <thead>
        <tr>
          <th (click)="sort('created','auditLog')"><span class="p-r-xs" translate>auditLog.label.created</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'created' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'created' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('account','auditLog')"><span class="p-r-xs" translate>auditLog.label.account</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'account' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'account' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('request','auditLog')"><span class="p-r-xs" translate>auditLog.label.request</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'request' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'request' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('category','auditLog')"><span class="p-r-xs" translate>auditLog.label.category</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'category' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'category' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('comment','auditLog')"><span class="p-r-xs" translate>auditLog.label.comment</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'comment' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'comment' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('timeSpend','auditLog')"><span class="p-r-xs" translate>auditLog.label.timeSpend</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'timeSpend' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'timeSpend' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
          <th (click)="sort('ticketLink','auditLog')"><span class="p-r-xs" translate>auditLog.label.ticketLink</span>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'ticketLink' && !workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-up "></i>
            <i *ngIf="workflowFilters.auditLogFilter.sortBy == 'ticketLink' && workflowFilters.auditLogFilter.reverse"
               class="fa fa-caret-down "></i></th>
        </tr>
        </thead>
        <tbody>
        <ng-template ngFor let-auditLog [ngForOf]="auditTable.data">
          <tr>
            <td>
              <i class="cursor fa fa-caret-down fa-lg tableexport-ignore" *ngIf="!auditLog.show"
                 (click)="auditLog.show =true"></i>
              <i class="cursor fa fa-caret-up fa-lg tableexport-ignore"
                 *ngIf="auditLog.show" (click)="auditLog.show =false"></i>
              &nbsp;
              <span [innerHtml]="auditLog.created | stringToDate"></span>
            </td>
            <td><span [innerHtml]="auditLog.account"></span></td>
            <td><span [innerHtml]="auditLog.request"></span></td>
            <td><span [innerHtml]="auditLog.category"></span></td>
            <td><span [innerHtml]="auditLog.comment"></span></td>
            <td>
            <span *ngIf="auditLog.timeSpent">
              <span [innerHtml]="auditLog.timeSpent"></span><span>m</span>
            </span>
            </td>
            <td>
              <a href="{{auditLog.ticketLink}}" class="text-hover-primary" target="_blank"
                 [innerHtml]="auditLog.ticketLink"></a>
            </td>
          </tr>
          <tr class="tableexport-ignore" *ngIf="auditLog.show">
            <td></td>
            <td colspan="6">
              <div class="m-a-0">
                <span translate>auditLog.label.requestBody</span>
                :
                <span [innerHtml]="auditLog.parameters"></span>
              </div>
            </td>
          </tr>
        </ng-template>
        </tbody>
      </nz-table>
    </div>
  </nz-tab>
</nz-tabset>
