@if (isProcessing) {
  <div class="operation-status-info">
    <div id='prog-bar-cont'>
      <div id="prog-bar">
        <div id="background"></div>
      </div>
    </div>
  </div>
}
<div>
  <div [height]="workflowFilters.panelSize" [workflowTab]="workflowFilters" appResizable class="resizable"
       id="workflowGraphId">
    <div class="overflow-y h-full">
      <div [ngClass]="{'graph2': isModal}" class="graph-container">
        <div class="inline" id="toolbar-icons">
          <ul class="nav navbar-nav navbar-nav-inline nav-active-border3 ">
            <li class="nav-item">
              <a (click)="zoomIn()" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'workflow.button.zoomIn' | translate"
                 class="nav-link">
                <span class="nav-text"> <i nz-icon nzTheme="outline" nzType="zoom-in"></i></span>
              </a>
            </li>
            <li class="nav-item">
              <a (click)="zoomOut()"
                 [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'workflow.button.zoomOut' | translate" class="nav-link">
                <span class="nav-text"> <i nz-icon nzTheme="outline" nzType="zoom-out"></i></span>
              </a>
            </li>
            <li class="nav-item dropdown-separator">
              <span class="separator"></span>
            </li>
            <li class="nav-item">
              <a (click)="actual()" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'workflow.button.actual' | translate"
                 class="nav-link">
                <span class="nav-text"> <i nz-icon nzTheme="outline" nzType="fullscreen-exit"></i></span>
              </a>
            </li>
            <li class="nav-item">
              <a (click)="fit()" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'workflow.button.fit' | translate"
                 class="nav-link">
                <span class="nav-text"> <i nz-icon nzTheme="outline" nzType="column-width"></i></span>
              </a>
            </li>
            <li class="nav-item dropdown-separator">
              <span class="separator"></span>
            </li>
            <li class="nav-item">
              <a (click)="expandAll()" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'common.button.expandDetails' | translate"
                 class="nav-link">
                <span class="nav-text"> <i nz-icon nzTheme="outline" nzType="plus"></i></span>
              </a>
            </li>
            <li class="nav-item">
              <a (click)="collapseAll()" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'common.button.collapseDetails' | translate"
                 class="nav-link">
                <span class="nav-text"> <i nz-icon nzTheme="outline" nzType="minus"></i></span>
              </a>
            </li>
            <li class="nav-item dropdown-separator">
              <span class="separator"></span>
            </li>
            <li [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="'workflow.button.exportInPng' | translate" class="nav-item">
              <a (click)="workflowService.exportInPng(workFlowJson.name, isModal)"
                 class="nav-link">
                <span class="nav-text">  <i nz-icon nzTheme="outline" nzType="export"></i></span>
              </a>
            </li>
          </ul>
        </div>
        <div #graphEle id="graph"></div>
        <!-- Creates a container for the outline -->
        <div #outlineContainer id="outlineContainer"></div>
      </div>
      <!-- BEGIN SLIDER -->
      <div  class="property-panel left-property-panel hidden-sm">
        <div class="sidebar-open">
          <i class="fa fa-caret-left"></i>
        </div>
        <div class="sidebar-close">
          <i class="fa fa-caret-right"></i>
        </div>
        <div class="sidebar sidebar-property-panel bg-white" id="left-property-panel">
          <perfect-scrollbar class="tree-block">
            <div class="m-l-xxs m-b-xs">
              <a class="text-primary-hover" (click)="expandAllTree();">
                <i class="fa fa-angle-double-down fa-lg"></i>
              </a>
              <a class="m-l-sm text-primary-hover" (click)="collapseAllTree();">
                <i class="fa fa-angle-double-up fa-lg"></i>
              </a>
              <a (click)="objectTreeSearch()" class="tree-search tree-search1">
                <i [nzType]="'search'" nz-icon nzTheme="outline"></i>
              </a>
              <input (blur)="clearSearchInput()" (ngModelChange)="searchNodes($event)"
                     [(ngModel)]="searchNode.text"
                     [placeholder]="'workflow.placeholder.findNode' | translate"
                     class="input-tree-search"
                     id="workflowTreeSearch"
                     nz-input
              />

              <i [nzType]="searchNode.loading ? 'loading' : 'search'" class="graphical-tree-search-icon" nz-icon nzTheme="outline"></i>
            </div>
            <div class="fade-in">
              <nz-tree
                [nzShowExpand]="true"
                [nzData]="filteredNodes"
                [nzTreeTemplate]="nzTreeTemplate"
              ></nz-tree>
              <ng-template #nzTreeTemplate let-node>
                <div class="node-wrapper" id="{{node.origin.key}}" [ngClass]="{'disable-link':node.origin.disabled}">
                  <div (click)="selectNode(node.origin.key)" class="node-content-wrapper" [ngClass]="{'node-content-wrapper-active' : node.origin.key == selectedKey}">
                    @if (node.origin.name) {
                      <span> {{node.origin.name}} </span>
                    }
                    <span class="_600">{{node.origin.title | translate}}</span>
                  </div>
                </div>
              </ng-template>
            </div>
            @if (graph?.getSelectionCell()) {
              <div class="card p-a pos-abt text-18 prev-next-icon" style="margin-left: 255px; bottom: 8px">
                <a (click)="prev()" class="text-primary-hover"><span nz-icon nzType="left-circle" nzTheme="outline"></span></a>
                <a (click)="next()" class="text-primary-hover m-l-12"><span nz-icon nzType="right-circle" nzTheme="outline"></span></a>
              </div>
            }
          </perfect-scrollbar>
        </div>
      </div>
      <nz-dropdown-menu #menu="nzDropdownMenu">
        @if (order) {
          <ul nz-menu>
            @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state &&
            (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED') &&
            (order.state._text !== 'RUNNING')) {
              <li (click)="cancelOrder()" nz-menu-item>
                <a translate>order.button.cancel</a>
              </li>
            }

            @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state &&
            (order.state._text === 'RUNNING')) {
              <li (click)="$event.preventDefault();$event.stopPropagation()"
                  nz-submenu
                  [nzTitle]="'order.button.cancel' | translate">
                <ul>
                  @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
                    <li (click)="cancelOrder()" nz-menu-item>
                      <a translate>order.button.cancelSoftly</a>
                    </li>
                  }
                  @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text === 'RUNNING')) {
                    <li (click)="cancelOrderWithKill()" nz-menu-item>
                      <a translate>order.button.force</a>
                    </li>
                  }
                </ul>
              </li>
            }
            @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
              <li nz-submenu [nzTitle]="'order.button.deepCancel' | translate">
                <ul>
                  @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
                    <li (click)="deepCancel()" nz-menu-item>
                      <a translate>order.button.cancelSoftly</a>
                    </li>
                  }
                  @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
                    <li (click)="cancelOrderWithKill(true)" nz-menu-item>
                      <a translate>order.button.force</a>
                    </li>
                  }
                </ul>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && order.isSuspendible || (order.state._text === 'RUNNING') || (order.state._text === 'RUNNING' || order.state._text === 'SCHEDULED' || order.state._text === 'PENDING'
              || order.state._text === 'INPROGRESS' || order.state._text === 'PROMPTING' || order.state._text === 'WAITING')) {
              <li (click)="$event.preventDefault();$event.stopPropagation()"
                  [nzTitle]="'order.button.suspend' | translate" nz-submenu>
                <ul>
                  @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
                    <li (click)="normal()" nz-menu-item>
                      <a translate>order.button.normal</a>
                    </li>
                  }
                  @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible) && order.state && (order.state._text === 'RUNNING')) {
                    <li (click)="force()" nz-menu-item>
                      <a translate>order.button.force</a>
                    </li>
                  }
                  @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
                    <li (click)="reset()" nz-menu-item>
                      <a translate>order.button.reset</a>
                    </li>
                  }
                  @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible) && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')  && !order.state._reason === 'SLEEPING') {
                    <li (click)="forceReset()" nz-menu-item>
                      <a translate>order.button.forceReset</a>
                    </li>
                  }
                </ul>
              </li>
            }
            @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.suspendResume) {
              <li (click)="$event.preventDefault();$event.stopPropagation()"
                  [nzTitle]="'order.button.deepSuspend' | translate" nz-submenu>
                <ul>
                  @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
                    <li (click)="deepSuspendNormal(true)" nz-menu-item>
                      <a translate>order.button.normal</a>
                    </li>
                  }
                  @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
                    <li (click)="deepSuspendForce()" nz-menu-item>
                      <a translate>order.button.force</a>
                    </li>
                  }
                  @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
                    <li (click)="deepSuspendReset(true)" nz-menu-item>
                      <a translate>order.button.reset</a>
                    </li>
                  }
                  @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.suspendResume && (order.state._text === 'RUNNING' || order.state._text === 'SCHEDULED' || order.state._text === 'PENDING'
                    || order.state._text === 'INPROGRESS' || order.state._text === 'PROMPTING' || order.state._text === 'WAITING')) {
                    <li (click)="deepSuspendForceReset()" nz-menu-item>
                      <a translate>order.button.forceReset</a>
                    </li>
                  }
                </ul>
              </li>
            }
            @if (permission && permission.currentController && (permission.currentController.orders.suspendResume || (permission.currentController.orders.resumeFailed && order.state._text === 'FAILED')) && order.isResumable) {
              <li (click)="resumeOrder()" nz-menu-item>
                <a>{{'order.button.resume' | translate}} ..</a>
              </li>
            }
            @if (order.isContinuable && permission && permission.currentController && permission.currentController.orders.modify) {
              <li (click)="continueOrder()" nz-menu-item>
                <a>{{'order.button.continue' | translate}} </a>
              </li>
            }
            @if (!order.positionIsImplicitEnd && permission && permission.currentController && permission.currentController.orders.modify && order.state && (order.state._text === 'SCHEDULED' || order.state._text === 'PENDING' || order.state._text === 'BLOCKED')) {
              <li (click)="modifyOrder()" nz-menu-item>
                <a>{{'dailyPlan.button.setStartTime' | translate}} ..</a>
              </li>
            }
            @if (!order.positionIsImplicitEnd && permission && permission.currentController && permission.currentController.orders.modify && order.state && (order.state._text === 'SCHEDULED' || order.state._text === 'PENDING' || order.state._text === 'BLOCKED')) {
              <li (click)="changeParameter()" nz-menu-item>
                <a>{{'dailyPlan.button.setParameters' | translate}} ..</a>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.cancel && order.canLeave) {
              <li (click)="removeWhenTerminated()" nz-menu-item>
                <a translate>order.button.leaveWorkflow</a>
              </li>
            }
            @if (!order.positionIsImplicitEnd && permission && permission.currentController && permission.currentController.orders.confirm && order.state && (order.state._text === 'PROMPTING')) {
              <li (click)="confirmOrder()" nz-menu-item>
                <a>{{'order.button.confirm' | translate}} ..</a>
              </li>
            }
            @if (order.state && (order.state._text !== 'SCHEDULED' && order.state._text !== 'PENDING')) {
              <li nz-menu-divider></li>
            }
            @if (order.state && (order.state._text !== 'SCHEDULED' && order.state._text !== 'PENDING')) {
              <li (click)="showLog(order)" nz-menu-item>
                <a>{{'order.button.showLog' | translate}}</a>
              </li>
            }
            @if (order.state && (order.state._text !== 'SCHEDULED' && order.state._text !== 'PENDING')) {
              <li (click)="coreService.copyLink('order',order.orderId, order.workflowId.path)" nz-menu-item>
                <a translate>common.button.copyLinkToObject</a>
              </li>
            }
          </ul>
        }
        @if (stopInstruction) {
          <ul nz-menu>
            @if (stopInstruction.label && permission.currentController && permission.currentController.orders.managePositions &&  !stopInstruction.isSkip) {
              <li (click)="skip(stopInstruction);" nz-menu-item>
                <a>
                  <span translate>workflow.button.skip</span>
                </a>
              </li>
            }
            @if (stopInstruction.label &&  permission.currentController && permission.currentController.orders.managePositions && stopInstruction.isSkip) {
              <li (click)="unskip(stopInstruction);" nz-menu-item>
                <a>
                  <span translate>workflow.button.unskip</span>
                </a>
              </li>
            }
            @if (permission.currentController && permission.currentController.orders.managePositions && !stopInstruction.isStop) {
              <li (click)="stop(stopInstruction);" nz-menu-item>
                <a>
                  <span translate>workflow.button.stop</span>
                </a>
              </li>
            }
            @if (permission.currentController && permission.currentController.orders.managePositions && stopInstruction.isStop) {
              <li (click)="unstop(stopInstruction);" nz-menu-item>
                <a>
                  <span translate>workflow.button.unstop</span>
                </a>
              </li>
            }
          </ul>
        }
        @if (job) {
          <ul nz-menu>
            @if (permission.currentController && permission.currentController.orders.managePositions && !job.isSkip) {
              <li (click)="skip(job);" nz-menu-item>
                <a>
                  <span translate>workflow.button.skip</span>
                </a>
              </li>
            }
            @if (permission.currentController && permission.currentController.orders.managePositions && job.isSkip) {
              <li (click)="unskip(job);" nz-menu-item>
                <a>
                  <span translate>workflow.button.unskip</span>
                </a>
              </li>
            }
            @if (permission.currentController && permission.currentController.orders.managePositions && !job.isStop) {
              <li (click)="stop(job);" nz-menu-item>
                <a>
                  <span translate>workflow.button.stop</span>
                </a>
              </li>
            }
            @if (permission.currentController && permission.currentController.orders.managePositions && job.isStop) {
              <li (click)="unstop(job);" nz-menu-item>
                <a>
                  <span translate>workflow.button.unstop</span>
                </a>
              </li>
            }
            <li (click)="showConfiguration(job);" nz-menu-item>
              <a translate>common.button.showConfiguration</a>
            </li>
            @if (job.jobName) {
              <li (click)="coreService.showDocumentation(job.documentationName, preferences)" [nzDisabled]="!job.documentationName" nz-menu-item>
                <a translate>common.button.viewDocumentation</a>
              </li>
            }
            @if (job && permission.currentController && permission.currentController.orders.view) {
              <li (click)="viewHistory(job)" nz-menu-item>
                <a>
                  <span translate>common.button.showHistory</span>
                </a>
              </li>
            }
          </ul>
        }
      </nz-dropdown-menu>
      <div [hidden]="isModal" class="rg-bottom"><span></span></div>
    </div>
  </div>
</div>
<!-- BEGIN SLIDER -->
<nz-drawer (nzOnClose)="sideBar.isVisible = false" [nzVisible]="sideBar.isVisible" nzPlacement="right">
  <ng-container *nzDrawerContent>
    <div (click)="sideBar.isVisible = false" class="close-btn"></div>
    <div class="p-l-sm p-r-sm">
      <app-order-list-sidebar [orderPreparation]="orderPreparation" [orders]="sideBar.orders"
                              [permission]="permission" [preferences]="preferences"
                              [schedulerId]="controllerId"></app-order-list-sidebar>
    </div>
  </ng-container>
</nz-drawer>
<!-- END SLIDER -->
