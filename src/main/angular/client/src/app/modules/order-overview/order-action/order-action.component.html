<div class="btn-group dropdown">
  <button (nzVisibleChange)="change($event)" [disabled]="isDisabled" [nzDropdownMenu]="option" class="btn-drop more-option-h" nz-dropdown
          nzTrigger="click" type="button">
    <i class="fa fa-ellipsis-h"></i>
  </button>
  <nz-dropdown-menu #option="nzDropdownMenu" role="menu">
    <ul nz-menu>
      @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED') && !(order.state._text === 'RUNNING')) {
        <li (click)="cancelOrder(order)" nz-menu-item>
          <a translate>order.button.cancel</a>
        </li>
      }

      @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text === 'RUNNING')) {
        <li (click)="$event.preventDefault();$event.stopPropagation()" nz-submenu [nzTitle]="'order.button.cancel' | translate">
          <ul>
            @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
              <li (click)="cancelOrder(order)" nz-menu-item>
                <a translate>order.button.cancelSoftly</a>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text === 'RUNNING')) {
              <li (click)="cancelOrderWithKill()" nz-menu-item>
                <a translate>order.button.force</a>
              </li>
            }
          </ul>
        </li>
      }
      @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
        <li nz-submenu [nzTitle]="'order.button.deepCancel' | translate">
          <ul>
            @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
              <li (click)="deepCancel(true)" nz-menu-item>
                <a translate>order.button.cancelSoftly</a>
              </li>
            }
            @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.cancel && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')) {
              <li (click)="cancelOrderWithKill(true)" nz-menu-item>
                <a translate>order.button.force</a>
              </li>
            }
          </ul>
        </li>
      }
      @if (permission && permission.currentController && permission.currentController.orders.suspendResume && order.isSuspendible || (order.state._text === 'RUNNING') || (order.state._text === 'RUNNING' || order.state._text === 'SCHEDULED' || order.state._text === 'PENDING'
        || order.state._text === 'INPROGRESS' || order.state._text === 'PROMPTING' || order.state._text === 'WAITING')) {
        <li (click)="$event.preventDefault();$event.stopPropagation()" [nzTitle]="'order.button.suspend' | translate" nz-submenu>
          <ul>
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
              <li (click)="normal(order)" nz-menu-item>
                <a translate>order.button.normal</a>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible) && order.state && (order.state._text === 'RUNNING')) {
              <li (click)="force(order)" nz-menu-item>
                <a translate>order.button.force</a>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
              <li (click)="reset(order)" nz-menu-item>
                <a translate>order.button.reset</a>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible) && order.state && (order.state._text !== 'FINISHED' && order.state._text !== 'CANCELLED')  && !order.state._reason === 'SLEEPING') {
              <li (click)="forceReset(order)" nz-menu-item>
                <a translate>order.button.forceReset</a>
              </li>
            }
          </ul>
        </li>
      }
      @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.suspendResume) {
        <li (click)="$event.preventDefault();$event.stopPropagation()" [nzTitle]="'order.button.deepSuspend' | translate" nz-submenu>
          <ul>
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
              <li (click)="deepSuspendNormal(true)" nz-menu-item>
                <a translate>order.button.normal</a>
              </li>
            }
            @if (permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
              <li (click)="deepSuspendForce()" nz-menu-item>
                <a translate>order.button.force</a>
              </li>
            }
            @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.suspendResume && (order.isSuspendible)) {
              <li (click)="deepSuspendReset(true)" nz-menu-item>
                <a translate>order.button.reset</a>
              </li>
            }
            @if (order.hasChildOrders && permission && permission.currentController && permission.currentController.orders.suspendResume && (order.state._text === 'RUNNING' || order.state._text === 'SCHEDULED' || order.state._text === 'PENDING'
              || order.state._text === 'INPROGRESS' || order.state._text === 'PROMPTING' || order.state._text === 'WAITING')) {
              <li (click)="deepSuspendForceReset()" nz-menu-item>
                <a translate>order.button.forceReset</a>
              </li>
            }
          </ul>
        </li>
      }
      @if (permission && permission.currentController && (permission.currentController.orders.suspendResume || (permission.currentController.orders.resumeFailed && order.state._text === 'FAILED')) && order.isResumable) {
        <li (click)="resumeOrder()" nz-menu-item>
          <a>{{ 'order.button.resume' | translate }} ..</a>
        </li>
      }
      @if (order.isContinuable && permission && permission.currentController && permission.currentController.orders.modify) {
        <li (click)="continueOrder()" nz-menu-item>
          <a>{{ 'order.button.continue' | translate }}</a>
        </li>
      }
      @if (!order.positionIsImplicitEnd && permission && permission.currentController && permission.currentController.orders.modify && order.state && (order.state._text === 'SCHEDULED' || order.state._text === 'PENDING' || order.state._text === 'BLOCKED')) {
        <li (click)="modifyOrder(order)" nz-menu-item>
          <a>{{ 'dailyPlan.button.setStartTime' | translate }} ..</a>
        </li>
      }
      @if (!order.positionIsImplicitEnd && permission && permission.currentController && permission.currentController.orders.modify && order.state && (order.state._text === 'SCHEDULED' || order.state._text === 'PENDING' || order.state._text === 'BLOCKED')) {
        <li (click)="changeParameter(order)" nz-menu-item>
          <a>{{ 'dailyPlan.button.setParameters' | translate }} ..</a>
        </li>
      }
      @if (permission && permission.currentController && permission.currentController.orders.modify) {
        <li (click)="modifyPriority(order)" nz-menu-item>
          <a>{{ 'inventory.button.modifyPriority' | translate }}</a>
        </li>
      }
      @if (permission && permission.currentController && permission.currentController.orders.cancel && order.canLeave) {
        <li (click)="removeWhenTerminated()" nz-menu-item>
          <a translate>order.button.leaveWorkflow</a>
        </li>
      }
      @if (permission && permission.currentController && permission.currentController.orders.confirm && order.state && (order.state._text === 'PROMPTING')) {
        <li (click)="confirmOrder()" nz-menu-item>
          <a>{{ 'order.button.confirm' | translate }} ..</a>
        </li>
      }
      <li nz-menu-divider></li>
      @if (permission.currentController.orders.create && order.state && (order.state._text == 'SCHEDULED' || order.state._text == 'PENDING')) {
        <li (click)="cloneOrder(order)" nz-menu-item>
          <a translate>order.button.cloneOrder</a>
        </li>
      }
      <li (click)="coreService.copyArguments(order, 'arguments', message)" nz-menu-item [nzDisabled]="!order.arguments">
        <a translate>common.button.copyArguments</a>
      </li>
      @if (order.state && (order.state._text !== 'SCHEDULED' && order.state._text !== 'PENDING')) {
        <li (click)="showLog(order)" nz-menu-item>
          <a>{{ 'order.button.showLog' | translate }}</a>
        </li>
      }
      <li nz-menu-divider></li>
      <li (click)="coreService.copyLink('order',order.orderId, order.workflowId.path)" nz-menu-item>
        <a translate>common.button.copyLinkToObject</a>
      </li>
      <li (click)="copyOrderId(order.orderId)" nz-menu-item>
        <a translate>common.button.copyOrderId</a>
      </li>
    </ul>
  </nz-dropdown-menu>
</div>
