<div class="modal-header">
  <h4 class="modal-title">{{ title }}</h4>
  <button
    (click)="activeModal.destroy()"
    aria-label="Close"
    class="close"
    type="button"
  >
    <span aria-hidden="true" class="fa fa-times-circle"></span>
  </button>
</div>

<form [formGroup]="form" (ngSubmit)="onSubmit()" spellcheck="false">
  <div class="modal-body p-a p-t-sm">
    <div class="row">
      <div
        class="col-md-12"
        *ngFor="let key of propertyKeys"
        style="margin-bottom: 1rem;"
      >
        <div class="form-group row">
          <div class="col-md-3 form-control-label">
            <label class="control-label">{{ key }}</label>
          </div>
          <div class="col-md-6">
            <ng-container [ngSwitch]="getFieldType(key)">

              <ng-container *ngSwitchCase="'string'">
                <input
                  type="text"
                  class="form-control"
                  [formControlName]="key"
                  [placeholder]="key"
                />
              </ng-container>

              <ng-container *ngSwitchCase="'integer'">
                <input
                  type="number"
                  class="form-control"
                  [formControlName]="key"
                  [placeholder]="key"
                />
              </ng-container>

              <ng-container *ngSwitchCase="'number'">
                <input
                  type="number"
                  class="form-control"
                  [formControlName]="key"
                  [placeholder]="key"
                />
              </ng-container>

              <ng-container *ngSwitchCase="'boolean'">
                <div class="checkbox">
                  <label>
                    <input type="checkbox" [formControlName]="key"/>
                  </label>
                </div>
              </ng-container>

              <ng-container *ngSwitchCase="'object'">
                <!-- if this schema allows arbitrary props -->
                <ng-container *ngIf="isMap(key); else fixedObject">
                  <button type="button"
                          class="btn btn-grey btn-xs"
                          (click)="addMapEntry(key)">
                    <i class="fa fa-plus"></i>
                  </button>
                  <div formArrayName="{{ key }}" style="margin-top:0.5rem">
                    <div *ngFor="let grp of getMapArray(key).controls; let i = index"
                         [formGroupName]="i"
                         style="display:flex; gap:0.5rem; margin-bottom:0.25rem">
                      <input formControlName="key"
                             class="form-control"
                             placeholder="Name"
                             style="width:45%" />
                      <input formControlName="value"
                             class="form-control"
                             placeholder="Value"
                             style="width:45%" />
                      <button type="button"
                              class="btn btn-xs btn-danger"
                              (click)="removeMapEntry(key, i)">
                        ✕
                      </button>
                    </div>
                  </div>
                </ng-container>

                <!-- fallback to your existing nested‐object UI -->
                <ng-template #fixedObject>
                  <div
                    class="well"
                    [formGroupName]="key"
                  >
                    <fieldset>

                      <div
                        *ngFor="let child of childKeys(key)"
                        style="margin-bottom: 0.75rem;"
                      >
                        <label>{{ child }}</label>

                        <ng-container [ngSwitch]="getChildFieldType(key, child)">
                          <!-- string child -->
                          <ng-container *ngSwitchCase="'string'">
                            <input
                              type="text"
                              class="form-control"
                              [formControlName]="child"
                              [placeholder]="child"
                            />
                          </ng-container>

                          <ng-container *ngSwitchCase="'integer'">
                            <input
                              type="number"
                              class="form-control"
                              [formControlName]="child"
                              [placeholder]="child"
                            />
                          </ng-container>

                          <ng-container *ngSwitchCase="'number'">
                            <input
                              type="number"
                              class="form-control"
                              [formControlName]="child"
                              [placeholder]="child"
                            />
                          </ng-container>

                          <ng-container *ngSwitchCase="'boolean'">
                            <div class="checkbox">
                              <label>
                                <input type="checkbox" [formControlName]="child"/>
                                {{ child }}
                              </label>
                            </div>
                          </ng-container>

                          <ng-container *ngSwitchCase="'object'">
                            <div>…nested object here…</div>
                          </ng-container>

                          <ng-container *ngSwitchCase="'array'">
                            <button
                              type="button"
                              class="btn btn-grey btn-xs"
                              (click)="addNestedItem(key, child)"
                            >
                              <i class="fa fa-plus"></i>
                            </button>

                            <div [formArrayName]="child" style="margin-top: 0.5rem;">
                              <div
                                *ngFor="
                            let ctrl of getNestedFormArray(key, child).controls;
                            let i = index
                          "
                                [formGroupName]="i"
                                style="
                            display: flex;
                            align-items: center;
                            margin-bottom: 0.25rem;
                          "
                              >
                                <input
                                  type="text"
                                  class="form-control"
                                  formControlName="0"
                                />
                                <button
                                  type="button"
                                  class="btn btn-xs btn-danger"
                                  style="margin-left: 0.5rem;"
                                  (click)="removeNestedItem(key, child, i)"
                                >
                                  Remove
                                </button>
                              </div>
                            </div>
                          </ng-container>
                        </ng-container>

                        <div
                          *ngIf="
                      getNestedFormGroup(key).get(child).invalid &&
                      (
                        getNestedFormGroup(key).get(child).touched ||
                        getNestedFormGroup(key).get(child).dirty
                      )
                    "
                        >
                          <small class="text-danger" *ngIf="
                      getNestedFormGroup(key).get(child).hasError('required')
                    ">
                            {{ child }} is required
                          </small>
                          <small class="text-danger" *ngIf="
                      getNestedFormGroup(key).get(child).hasError('maxlength')
                    ">
                            Max length exceeded
                          </small>
                          <small class="text-danger" *ngIf="
                      getNestedFormGroup(key).get(child).hasError('pattern')
                    ">
                            Invalid format
                          </small>
                        </div>
                      </div>
                    </fieldset>
                  </div>

                </ng-template>
              </ng-container>

              <!-- 6) type="array" (top-level arrays) -->
              <ng-container *ngSwitchCase="'array'">
                <!-- Check if this is “array of objects” vs. “array of primitives” -->
                <ng-container *ngIf="isArrayOfObjects(key); else primitiveArray">
                  <!-- ─── Array of Objects ─── -->
                  <button
                    type="button"
                    class="btn btn-grey btn-xs"
                    (click)="addItem(key)"
                  >
                    <i class="fa fa-plus"></i>
                  </button>

                  <div [formArrayName]="key" style="margin-top: 0.5rem;">
                    <div
                      *ngFor="
                    let group of getFormArray(key).controls;
                    let i = index
                  "
                      [formGroupName]="i"
                      style="margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px;"
                    >
                      <!-- Each array element is an object. Render its fields now. -->
                      <!--  a) noticeBoardPath (string) -->
                      <div style="margin-bottom: 0.5rem;">
                        <label>noticeBoardPath</label>
                        <input
                          type="text"
                          class="form-control"
                          [formControlName]="'noticeBoardPath'"
                        />
                        <div
                          *ngIf="
                        getArrayElementFormGroup(key, i)
                          .get('noticeBoardPath')
                          .invalid &&
                        (
                          getArrayElementFormGroup(key, i)
                            .get('noticeBoardPath')
                            .touched ||
                          getArrayElementFormGroup(key, i)
                            .get('noticeBoardPath')
                            .dirty
                        )
                      "
                        >
                          <small class="text-danger" *ngIf="
                        getArrayElementFormGroup(key, i)
                          .get('noticeBoardPath')
                          .hasError('required')
                      ">
                            noticeBoardPath is required
                          </small>
                          <small class="text-danger" *ngIf="
                        getArrayElementFormGroup(key, i)
                          .get('noticeBoardPath')
                          .hasError('maxlength')
                      ">
                            Max length exceeded
                          </small>
                          <small class="text-danger" *ngIf="
                        getArrayElementFormGroup(key, i)
                          .get('noticeBoardPath')
                          .hasError('pattern')
                      ">
                            Invalid format
                          </small>
                        </div>
                      </div>

                      <!--  b) workflowPaths (array of strings) -->
                      <div>
                        <label>workflowPaths</label>
                        <button
                          type="button"
                          class="btn btn-grey btn-xs"
                          (click)="addNestedItem(key, 'workflowPaths', i)"
                        >
                          <i class="fa fa-plus"></i>
                        </button>
                        <div
                          [formArrayName]="'workflowPaths'"
                          style="margin-top: 0.5rem;"
                        >
                          <div
                            *ngFor="
                          let pathCtrl of
                            getNestedFormArrayForIndex(key, 'workflowPaths', i)
                              .controls;
                          let j = index
                        "
                            style="
                          display: flex;
                          align-items: center;
                          margin-bottom: 0.25rem;
                        "
                          >
                            <input
                              type="text"
                              class="form-control"
                              [formControlName]="j"
                            />
                            <button
                              type="button"
                              class="btn btn-xs btn-danger"
                              style="margin-left: 0.5rem;"
                              (click)="removeNestedItem(key, 'workflowPaths', j, i)"
                            >
                              Remove
                            </button>
                          </div>
                        </div>
                      </div>

                      <!-- Remove the entire object from expectedNotices -->
                      <button
                        type="button"
                        class="btn btn-xs btn-danger"
                        style="margin-top: 0.5rem;"
                        (click)="removeItem(key, i)"
                      >
                        Remove Notice
                      </button>
                    </div>
                  </div>
                </ng-container>

                <!-- ─── Array of Primitives (fallback) ─── -->
                <ng-template #primitiveArray>
                  <button
                    type="button"
                    class="btn btn-grey btn-xs"
                    (click)="addItem(key)"
                  >
                    <i class="fa fa-plus"></i>
                  </button>
                  <div [formArrayName]="key" style="margin-top: 0.5rem;">
                    <div
                      *ngFor="
        let ctrl of getFormArray(key).controls;
        let idx = index
      "
                      style="
        display: flex;
        align-items: center;
        margin-bottom: 0.25rem;
      "
                    >
                      <!-- Bind each input directly to the FormControl at position idx -->
                      <input
                        type="text"
                        class="form-control"
                        [formControlName]="idx"
                      />
                      <button
                        type="button"
                        class="btn btn-xs btn-danger"
                        style="margin-left: 0.5rem;"
                        (click)="removeItem(key, idx)"
                      >
                        Remove
                      </button>
                    </div>
                  </div>
                </ng-template>
              </ng-container>
            </ng-container>
          </div>
        </div>

        <!-- ─── Validation messages for top-level fields ─── -->
        <div
          *ngIf="
            form.get(key).invalid &&
            (form.get(key).touched || form.get(key).dirty)
          "
        >
          <small class="text-danger" *ngIf="form.get(key).hasError('required')">
            {{ key }} is required
          </small>
          <small class="text-danger" *ngIf="form.get(key).hasError('maxlength')">
            Max length exceeded
          </small>
          <small class="text-danger" *ngIf="form.get(key).hasError('pattern')">
            Invalid format
          </small>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-footer">
    <button
      [disabled]="form.invalid"
      class="btn btn-primary btn-xs"
      type="submit"
    >
      Submit
    </button>
    <button
      (click)="activeModal.destroy()"
      class="btn btn-grey btn-xs"
      type="button"
    >
      Cancel
    </button>
  </div>
</form>
