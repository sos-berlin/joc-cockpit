<div class="white box-shadow sub-header">
  <div class="row">
    <div class="col-md-12">
      <div class="padding">
        <div class="text-right ">
          <div class="pull-left">
            <app-breadcrumbs></app-breadcrumbs>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div class="scroll-y max-ht">
  <div class="padding p-b-0">
    <div class="m-t-sm box p-a">
      @if (workflowPath && orderId) {
        <div class="table-responsive">
          <nz-table
            #ajaxOrderTable
            [nzBordered]="true"
            [nzData]="history"
            [nzLoading]="loading"
            [nzFrontPagination]="false"
            [nzShowPagination]="false"
            [nzShowSizeChanger]="false"
            [nzSize]="'small'"
          >
            <thead>
            <tr>
              <th><span translate>history.label.orderId</span></th>
              <th><span translate>history.label.workflow</span></th>
              <th><span translate>workflow.label.label</span></th>
              <th><span translate>history.label.status</span></th>
              <th><span translate>history.label.orderState</span></th>
              <th><span translate>history.label.plannedTime</span></th>
              <th><span translate>history.label.startTime</span></th>
              <th><span translate>history.label.endTime</span></th>
              <th><span translate>history.label.duration</span></th>
            </tr>
            </thead>
            <tbody>
              @for (history of ajaxOrderTable.data; track history) {
                <tr class="cursor">
                  <td>
                  <span (click)="coreService.showLogWindow(history,null,null,null,null,null)"
                        class="show-in-single-line w-full">
                    @if (!history.show) {
                      <i (click)="showPanelFuc(history);$event.stopPropagation()"
                         class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs"></i>
                    }
                    @if (history.show) {
                      <i (click)="hidePanelFuc(history);$event.stopPropagation()"
                         class="cursor fa fa-caret-up fa-lg p-l-xs p-r-xs"></i>
                    }
                    <i (click)="coreService.downloadLog(history, controllerId);$event.stopPropagation()"
                       class="cursor fa fa-download text-hover-primary p-r-xs"></i>
                    <span [innerHtml]="history.orderId"></span>
                  </span>
                  </td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)">
                  <span class="show-in-single-line w-full">
                    @if (permission.joc && permission.joc.inventory.view) {
                      <i (click)="navToWorkflowTab(history.workflow);$event.stopPropagation()"
                         class="cursor fa fa-pencil text-hover-primary p-r-xs"></i>
                    }
                    <span (click)="coreService.showWorkflow(history.workflow);$event.stopPropagation()"
                          [innerHtml]="history.workflow" class="text-hover-primary"></span>
                  </span>
                  </td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)">
                    @if (history.label) {
                      <span class="cur-point" [innerHtml]="history.label" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="history.position"></span>
                    }
                    @if (!history.label) {
                      <span [innerHtml]="history.position"></span>
                    }
                  </td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)">
                    @if (history.state) {
                      <span [innerHtml]="history.state._text | translate" [ngClass]="coreService.getColor(history.state.severity,'bg')"
                            class="label"></span>
                    }
                  </td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)">
                    @if (history.orderState) {
                      <span [innerHtml]="history.orderState._text | translate"
                            [ngClass]="coreService.getColor(history.orderState.severity,'bg')"
                            class="label"></span>
                    }
                  </td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)"
                      [innerHtml]="history.plannedTime | stringToDate"></td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)"
                      [innerHtml]="history.startTime | stringToDate"></td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)"
                      [innerHtml]="history.endTime | stringToDate"></td>
                  <td (click)="coreService.showLogWindow(history,null, null, controllerId, null,null)"
                      [innerHtml]="history.startTime | duration:history.endTime"></td>
                </tr>
                @if (history.show && history.arguments) {
                  <tr>
                    <td colspan="10">
                      <app-order-variable [history]="true" [order]="history" [schedulerId]="controllerId"
                                          [type]="'arguments'"></app-order-variable>
                    </td>
                  </tr>
                }
                @if (history.show) {
                  <tr>
                    <td colspan="10" style="padding:0 !important;">
                      <app-order-history-template [historyView]="{}" [history]="history"
                                                  [permission]="permission" [schedulerId]="controllerId" class="order-history-template0"
                                                  style="display: block"
                      ></app-order-history-template>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </nz-table>
        </div>
      }
      @if (taskId) {
        <div class="table-responsive">
          <nz-table
            #ajaxJobTable
            [nzBordered]="true"
            [nzData]="history"
            [nzLoading]="loading"
            [nzFrontPagination]="false"
            [nzShowPagination]="false"
            [nzShowSizeChanger]="false"
            [nzSize]="'small'"
          >
            <thead>
            <tr>
              <th><span translate>history.label.job</span></th>
              <th><span translate>history.label.workflow</span></th>
              <th><span translate>workflow.label.label</span></th>
              <th><span translate>history.label.status</span></th>
              <th><span translate>history.label.startTime</span></th>
              <th><span translate>history.label.endTime</span></th>
              <th><span translate>history.label.duration</span></th>
              <th><span translate>history.label.criticality</span></th>
              <th><span translate>history.label.returnCode</span></th>
            </tr>
            </thead>
            <tbody>
              @for (jobHistory of ajaxJobTable.data; track jobHistory) {
                <tr [ngClass]="{'light-bg':jobHistory.show}" class="cursor">
                  <td (click)="coreService.showLogWindow(null,jobHistory, null, jobHistory.controllerId, null,null)">
                  <span class="show-in-single-line">
                    <i (click)="jobHistory.show=!jobHistory.show;$event.stopPropagation()"
                       [ngClass]="jobHistory.show ? 'fa-caret-up' : 'fa-caret-down'"
                       class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs"></i>
                    <i (click)="coreService.downloadLog(jobHistory,jobHistory.controllerId);$event.stopPropagation()"
                       class="cursor fa fa-download  text-hover-primary p-r-xs"></i>
                    <span [innerHtml]="jobHistory.job"></span>
                  </span>
                  </td>
                  <td (click)="coreService.showLogWindow(null,jobHistory, null, jobHistory.controllerId, null,null)">
                  <span class="show-in-single-line w-full">
                    @if (permission.joc && permission.joc.inventory.view) {
                      <i (click)="navToWorkflowTab(jobHistory.workflow);$event.stopPropagation()"
                         class="cursor fa fa-pencil text-hover-primary p-r-xs"></i>
                    }
                    <span (click)="coreService.showWorkflow(jobHistory.workflow);$event.stopPropagation()"
                          [innerHtml]="jobHistory.workflow" class="text-hover-primary"></span>
                  </span>
                  </td>
                  <td (click)="coreService.showLogWindow(null,jobHistory, null, jobHistory.controllerId, null,null)">
                    @if (jobHistory.label) {
                      <span class="cur-point" [innerHtml]="jobHistory.label" [nzTooltipMouseEnterDelay]="0.5" [nz-tooltip]="jobHistory.position"></span>
                    }
                    @if (!jobHistory.label) {
                      <span [innerHtml]="jobHistory.position"></span>
                    }
                  </td>
                  <td (click)="coreService.showLogWindow(null,jobHistory,null,jobHistory.controllerId,null,null)">
                  <span [innerHtml]="jobHistory.state._text | translate"
                        [ngClass]="coreService.getColor(jobHistory.state.severity,'bg')"
                        class="label"></span>
                  </td>
                  <td (click)="coreService.showLogWindow(null,jobHistory,null,jobHistory.controllerId,null,null)"
                      [innerHtml]="jobHistory.startTime | stringToDate"></td>
                  <td (click)="coreService.showLogWindow(null,jobHistory,null,jobHistory.controllerId,null,null)"
                      [innerHtml]="jobHistory.endTime | stringToDate"></td>
                  <td (click)="coreService.showLogWindow(null,jobHistory,null,jobHistory.controllerId,null,null)"
                      [innerHtml]="jobHistory.startTime | duration:jobHistory.endTime"></td>
                  <td (click)="coreService.showLogWindow(null,jobHistory,null,jobHistory.controllerId,null,null)"
                      [innerHtml]="jobHistory.criticality | translate"></td>
                  <td (click)="coreService.showLogWindow(null,jobHistory,null,jobHistory.controllerId,null,null)"
                      [innerHtml]="jobHistory.exitCode"></td>
                </tr>
                @if (jobHistory.show) {
                  <tr>
                    <td colspan="10">
                      <app-order-variable [history]="true" [order]="jobHistory" [schedulerId]="controllerId"
                                          [type]="'arguments'"></app-order-variable>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </nz-table>
        </div>
      }
      @if (commitId) {
        <div class="table-responsive">
          <nz-table
            #ajaxTable
            [nzBordered]="true"
            [nzData]="history"
            [nzLoading]="loading"
            [nzFrontPagination]="false"
            [nzShowPagination]="false"
            [nzShowSizeChanger]="false"
            [nzSize]="'small'"
          >
            <thead>
            <tr>
              <th style="width: 25%"><span translate>common.label.controllerId</span></th>
              <th style="width: 25%"><span translate>history.label.deploymentDate</span></th>
              <th style="width: 25%"><span translate>common.label.account</span></th>
              <th style="width: 25%"><span translate>history.label.state</span></th>
            </tr>
            </thead>
            <tbody>
              @for (depHistory of ajaxTable.data; track depHistory) {
                <tr>
                  <td>
                    <span [innerHtml]="depHistory.controllerId"></span>
                  </td>
                  <td>
                    <span [innerHtml]="depHistory.deploymentDate | stringToDate"></span>
                  </td>
                  <td><span [innerHtml]="depHistory.account"></span></td>
                  <td><span [innerHtml]="depHistory.state | translate"
                            [ngClass]="{'bg-dark-blue' : depHistory.state=== 'DEPLOYED', 'bg-orange' : depHistory.state=== 'NOT_DEPLOYED'}"
                            class="label"></span></td>
                </tr>
                @if (depHistory.errorMessage) {
                  <tr>
                    <td colspan="4"><span class="text-danger">{{depHistory.errorMessage}}</span></td>
                  </tr>
                }
                <tr>
                  <td class="order-history-template0" colspan="4" style="padding:0 !important;">
                    <nz-table #innerChildTable [nzData]="depHistory.children" [nzFrontPagination]="false"
                              [nzShowPagination]="false" class="m-a-0 inner-table" nzSize="small">
                      <thead>
                      <tr>
                        <th nzWidth="19.95%"><span translate>history.label.deployType</span></th>
                        <th nzWidth="39.97%"><span translate>common.label.path</span></th>
                        <th nzWidth="19.95%"><span translate>history.label.operation</span></th>
                        <th nzWidth="19.95%"><span translate>history.label.date</span></th>
                      </tr>
                      </thead>
                      <tbody>
                        @for (child of innerChildTable.data; track child) {
                          <tr>
                            <td><span [innerHtml]="child.deployType | translate"></span></td>
                            <td>
                          <span class="show-in-single-line w-full">
                            @if (child.operation === 'UPDATE' && permission.joc && permission.joc.inventory.view) {
                              <i (click)="navToInventoryTab(child);$event.stopPropagation()"
                                 class="cursor fa fa-pencil text-hover-primary p-r-xs"></i>
                            }
                            <span
                              (click)="coreService.showWorkflow(child.path);$event.stopPropagation()"
                              [innerHtml]="child.path"
                              [ngClass]="(child.deployType === 'Workflow' && child.operation === 'UPDATE') ? 'text-hover-primary' : ''"></span>
                          </span>
                            </td>
                            <td><span [innerHtml]="child.operation | translate"></span></td>
                            <td [innerHtml]="child.deploymentDate | stringToDate"></td>
                          </tr>
                        }
                      </tbody>
                    </nz-table>
                  </td>
                </tr>
              }
            </tbody>
          </nz-table>
        </div>
      }
      @if (auditLogId) {
        <div class="table-responsive">
          <nz-table
            #ajaxTable
            [nzBordered]="true"
            [nzData]="history"
            [nzLoading]="loading"
            [nzFrontPagination]="false"
            [nzShowPagination]="false"
            [nzShowSizeChanger]="false"
            [nzSize]="'small'"
          >
            <thead>
            <tr>
              <th style="width: 50%"><span translate>history.label.dailyPlanDate</span></th>
              <th><span translate>history.label.countTotal</span></th>
            </tr>
            </thead>
            <tbody>
              @for (submissionHistory of ajaxTable.data; track submissionHistory) {
                <tr>
                  <td>
                  <span class="show-in-single-line w-full">
                      @if (!submissionHistory.show) {
                        <i (click)="expandDailyPlan(submissionHistory)"
                           class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs"></i>
                      }
                    @if (submissionHistory.show) {
                      <i (click)="submissionHistory.show = false;"
                         class="cursor fa fa-caret-up fa-lg p-l-xs p-r-xs"></i>
                    }
                    <span [innerHtml]="submissionHistory.date | stringToDate1"></span>
                    </span>
                  </td>
                  <td>
                    {{submissionHistory.countTotal}}
                  </td>
                </tr>
                @if (submissionHistory.show) {
                  <tr>
                    <td style="padding:0 !important;">
                      <nz-table #innerChildTable [nzData]="submissionHistory.controllers" [nzFrontPagination]="false"
                                [nzShowPagination]="false" class="m-a-0 inner-table"
                                nzSize="small">
                        <tbody>
                          @for (controller of innerChildTable.data; track controller) {
                            <tr>
                              <td class="custom-th" colspan="6">
                                <span class="p-l" translate>common.label.controllerId</span>:
                                <span [innerHtml]="controller.controllerId"></span>
                              </td>
                            </tr>
                            <tr>
                              <td class="custom-th" colspan="3"><span class="p-l" translate>history.label.submission</span></td>
                              <td class="custom-th" colspan="3"><span translate>history.label.submissionTotal</span></td>
                            </tr>
                            @for (child of controller.submissions; track child) {
                              <tr>
                                <td colspan="3">
                            <span class="p-l">
                              @if (!child.show) {
                                <i (click)="loadSubmissionOrders(submissionHistory, controller, child);child.show = true"
                                   class="cursor fa fa-caret-down fa-lg p-l-xs p-r-xs"></i>
                              }
                              @if (child.show) {
                                <i (click)="child.show = false;"
                                   class="cursor fa fa-caret-up fa-lg p-l-xs p-r-xs"></i>
                              }
                              <span [innerHtml]="child.submissionTime | stringToDate"></span>
                            </span>
                                </td>
                                <td colspan="3">
                                  {{child.countTotal}}
                                </td>
                              </tr>
                              @if (child.show) {
                                @if (!child.orderIds) {
                                  <tr>
                                    <td class="text-center" colspan="6">
                                      <nz-spin nzSimple></nz-spin>
                                    </td>
                                  </tr>
                                }
                                @if (child.orderIds && child.orderIds.length > 0) {
                                  <tr>
                                    <td class="custom-th" colspan="2">
                                      <span class="p-l-md" translate>history.label.orderId</span>
                                    </td>
                                    <td class="custom-th" colspan="2"><span translate>order.label.workflow</span></td>
                                    <td class="custom-th"><span translate>order.label.scheduledFor</span></td>
                                    <td class="custom-th"><span translate>common.label.status</span></td>
                                  </tr>
                                  @for (order of child.orderIds | orderBy: 'scheduledFor': true; track order) {
                                    <tr>
                                      <td colspan="2"><span [innerHtml]="order.orderId"
                                                            class="p-l-md"></span></td>
                                      <td colspan="2">
                                        @if (permission.joc && permission.joc.inventory.view) {
                                          <i (click)="navToWorkflowTab(order.workflowPath);$event.stopPropagation()"
                                             class="cursor fa fa-pencil text-hover-primary p-r-xs"></i>
                                        }
                                        <span (click)="coreService.showWorkflow(order.workflowPath);$event.stopPropagation()"
                                              [innerHtml]="order.workflowPath" class="text-hover-primary"></span>
                                      </td>
                                      <td><span>{{order.scheduledFor | stringToDate}}</span></td>
                                      <td>
                                        @if (order.submitted) {
                                          <span class="label bg-orange" translate>{{'submitted' | translate}}</span>
                                        }
                                        @if (!order.submitted) {
                                          <span class="label bg-red" translate>{{'notSubmitted' | translate}}</span>
                                        }
                                      </td>
                                    </tr>
                                  }
                                  @if ((child.orderIds).length === 0) {
                                    <tr>
                                      <td class="text-center" colspan="6">
                                        <span class="text-uppercase m-t-sm" translate>common.message.noDataMatched</span>
                                      </td>
                                    </tr>
                                  }
                                }
                                @if (child.warnMessages && child.warnMessages.length > 0) {
                                  <tr>
                                    <td class="custom-th" colspan="6"><span class="p-l-md" translate>history.label.warnMessages</span>
                                    </td>
                                  </tr>
                                }
                                @for (msg of child.warnMessages; track msg) {
                                  <tr>
                                    <td colspan="6"><span class="p-l-md text-warn">{{msg}}</span></td>
                                  </tr>
                                }
                                @if (child.errorMessages && child.errorMessages.length > 0) {
                                  <tr>
                                    <td class="custom-th" colspan="6"><span class="p-l-md" translate>history.label.errorMessages</span>
                                    </td>
                                  </tr>
                                }
                                @for (msg of child.errorMessages; track msg) {
                                  <tr>
                                    <td colspan="6"><span class="p-l-md text-danger">{{msg}}</span></td>
                                  </tr>
                                }
                              }
                            }
                          }
                        </tbody>
                      </nz-table>
                    </td>
                  </tr>
                }
              }
            </tbody>
          </nz-table>
        </div>
      }
    </div>
  </div>
</div>
